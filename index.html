<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mozzart Education - Manajemen Siswa</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Plugin Datalabels untuk Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- Lucide Icons for modern icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- SheetJS/XLSX for Excel file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1e293b;   /* slate-800 */
            --secondary-color: #4f46e5; /* indigo-600 */
            --background-color: #f1f5f9; /* slate-100 */
            --text-color: #334155;      /* slate-700 */
            --sidebar-bg: #ffffff;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }
        .sidebar-icon {
            stroke-width: 1.5;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .form-input, .form-select {
            border-color: #cbd5e1;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #334155;
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
             background-color: #4338ca;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05), 0 1px 2px -1px rgb(0 0 0 / 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
             box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
        }
        .card-title {
            font-size: 1.125rem;
            line-height: 1.75rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
        }
        .nav-link:not(.active):hover {
            transform: translateX(4px);
            background-color: #f1f5f9;
        }
        .input-menu-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .input-menu-card:hover {
            border-color: var(--secondary-color);
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
        }
        @media (min-width: 640px) {
            .card-title {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body class="text-slate-700">
    <!-- Login Container -->
    <div id="login-container" class="flex items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg m-4">
            <div class="text-center">
                <img id="login-logo" src="https://placehold.co/60x60/1e293b/ffffff?text=ME" alt="Mozzart Education Logo" class="mx-auto h-14 w-14 rounded-xl">
                <h2 class="mt-6 text-3xl font-bold text-slate-900" data-lang="appTitle">Mozzart Education</h2>
                <p class="mt-2 text-sm text-slate-600">Silakan masuk untuk melanjutkan</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm form-input" placeholder="Email address" value="">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-slate-300 placeholder-slate-500 text-slate-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm form-input" placeholder="Password" value="">
                    </div>
                </div>
                 <div id="login-error" class="text-red-500 text-sm text-center hidden">Email atau kata sandi salah.</div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-slate-800 hover:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 btn-primary">
                        Masuk
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <div class="relative min-h-screen md:flex backdrop-blur-xl bg-slate-100/30">
            <!-- Sidebar Overlay -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
            
            <!-- Sidebar -->
            <aside id="main-sidebar" class="fixed inset-y-0 left-0 bg-white/80 w-64 flex-col transition-transform duration-300 border-r border-slate-200 z-30 transform -translate-x-full md:translate-x-0 md:flex">
                <div class="flex items-center h-20 border-b border-slate-200 px-4 app-logo-container">
                    <img id="app-logo" src="https://placehold.co/40x40/1e293b/ffffff?text=ME" class="h-10 w-10 rounded-lg flex-shrink-0" alt="App Logo">
                    <h1 data-lang="appTitle" class="text-lg font-bold ml-3 text-slate-800 app-title-text">Mozzart Education</h1>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a href="#" class="nav-link active flex items-center p-3 rounded-lg text-white" data-view="dashboard" style="background-color: var(--primary-color);">
                        <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
                        <span data-lang="dashboard" class="ml-4 nav-text">Dasbor Kelas</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="rekap-nilai">
                        <i data-lucide="file-spreadsheet" class="sidebar-icon"></i>
                        <span data-lang="rekapNilai" class="ml-4 nav-text">Rekapitulasi Nilai</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="rapor-semester-1">
                        <i data-lucide="book-open-check" class="sidebar-icon"></i>
                        <span data-lang="raporSemester1" class="ml-4 nav-text">Rapor Semester 1</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="missing-scores">
                        <i data-lucide="alert-circle" class="sidebar-icon"></i>
                        <span data-lang="missingScores" class="ml-4 nav-text">Cek Nilai Kosong</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="data-input">
                        <i data-lucide="edit-3" class="sidebar-icon"></i>
                        <span data-lang="dataInput" class="ml-4 nav-text">Input Data</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="input-management">
                        <i data-lucide="folder-plus" class="sidebar-icon"></i>
                        <span data-lang="inputManagement" class="ml-4 nav-text">Manajemen Input</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="settings">
                        <i data-lucide="settings" class="sidebar-icon"></i>
                        <span data-lang="settings" class="ml-4 nav-text">Pengaturan</span>
                    </a>
                     <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="guide">
                        <i data-lucide="book-open" class="sidebar-icon"></i>
                        <span data-lang="guide" class="ml-4 nav-text">Panduan</span>
                    </a>
                </nav>
                <div class="p-4 border-t border-slate-200">
                    <a href="#" id="logout-btn" class="nav-link flex items-center p-3 rounded-lg text-slate-600 hover:bg-red-100 hover:text-red-600">
                        <i data-lucide="log-out" class="sidebar-icon"></i>
                        <span data-lang="logout" class="ml-4 nav-text">Keluar</span>
                    </a>
                </div>
            </aside>

            <!-- Main Content -->
            <main id="main-content" class="flex-1 flex flex-col overflow-hidden transition-all duration-300 md:ml-64">
                <header class="h-20 flex items-center justify-between px-4 md:px-8 border-b border-slate-200 bg-white/60 backdrop-blur-sm">
                    <div class="flex items-center">
                        <button id="menu-toggle" class="md:hidden p-2 mr-2 rounded-md text-slate-600 hover:bg-slate-100">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h2 id="view-title" data-lang="dashboard" class="text-xl sm:text-2xl font-semibold text-slate-800">Dasbor Kelas</h2>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <span class="mr-2 text-sm font-medium text-slate-600" data-lang="language">Bahasa:</span>
                            <div class="flex rounded-md shadow-sm">
                                <button id="lang-id" class="px-3 py-1 text-sm rounded-l-md bg-slate-800 text-white font-semibold">ID</button>
                                <button id="lang-en" class="px-3 py-1 text-sm rounded-r-md bg-slate-200 text-slate-700">EN</button>
                            </div>
                        </div>
                    </div>
                </header>
                <div class="flex-1 p-4 md:p-8 overflow-y-auto">
                    
                    <!-- Dashboard View -->
                    <div id="dashboard-view" class="view">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Level X Card -->
                            <div class="card flex flex-col h-full">
                                <h3 class="card-title text-center border-b pb-3 mb-4 text-indigo-700">Jenjang Kelas X</h3>
                                <div class="space-y-8 flex-1">
                                    <div>
                                        <h4 class="text-sm font-semibold text-center text-slate-600 mb-3 flex items-center justify-center gap-2">
                                            <i data-lucide="user-check" class="w-4 h-4"></i> Perkembangan Kehadiran
                                        </h4>
                                        <div class="chart-container" style="height: 220px;">
                                            <canvas id="chart-att-X"></canvas>
                                        </div>
                                    </div>
                                    <div class="pt-4 border-t border-slate-100">
                                        <h4 class="text-sm font-semibold text-center text-slate-600 mb-3 flex items-center justify-center gap-2">
                                            <i data-lucide="award" class="w-4 h-4"></i> Perkembangan Nilai
                                        </h4>
                                        <div class="chart-container" style="height: 220px;">
                                            <canvas id="chart-score-X"></canvas>
                                        </div>
                                    </div>
                                    <div id="solution-X" class="hidden pt-4 border-t border-slate-200 bg-red-50 p-4 rounded-md animate-pulse"></div>
                                </div>
                            </div>

                            <!-- Level XI Card -->
                            <div class="card flex flex-col h-full">
                                <h3 class="card-title text-center border-b pb-3 mb-4 text-indigo-700">Jenjang Kelas XI</h3>
                                <div class="space-y-8 flex-1">
                                    <div>
                                        <h4 class="text-sm font-semibold text-center text-slate-600 mb-3 flex items-center justify-center gap-2">
                                            <i data-lucide="user-check" class="w-4 h-4"></i> Perkembangan Kehadiran
                                        </h4>
                                        <div class="chart-container" style="height: 220px;">
                                            <canvas id="chart-att-XI"></canvas>
                                        </div>
                                    </div>
                                    <div class="pt-4 border-t border-slate-100">
                                        <h4 class="text-sm font-semibold text-center text-slate-600 mb-3 flex items-center justify-center gap-2">
                                            <i data-lucide="award" class="w-4 h-4"></i> Perkembangan Nilai
                                        </h4>
                                        <div class="chart-container" style="height: 220px;">
                                            <canvas id="chart-score-XI"></canvas>
                                        </div>
                                    </div>
                                    <div id="solution-XI" class="hidden pt-4 border-t border-slate-200 bg-red-50 p-4 rounded-md animate-pulse"></div>
                                </div>
                            </div>

                            <!-- Level XII Card -->
                            <div class="card flex flex-col h-full">
                                <h3 class="card-title text-center border-b pb-3 mb-4 text-indigo-700">Jenjang Kelas XII</h3>
                                <div class="space-y-8 flex-1">
                                    <div>
                                        <h4 class="text-sm font-semibold text-center text-slate-600 mb-3 flex items-center justify-center gap-2">
                                            <i data-lucide="user-check" class="w-4 h-4"></i> Perkembangan Kehadiran
                                        </h4>
                                        <div class="chart-container" style="height: 220px;">
                                            <canvas id="chart-att-XII"></canvas>
                                        </div>
                                    </div>
                                    <div class="pt-4 border-t border-slate-100">
                                        <h4 class="text-sm font-semibold text-center text-slate-600 mb-3 flex items-center justify-center gap-2">
                                            <i data-lucide="award" class="w-4 h-4"></i> Perkembangan Nilai
                                        </h4>
                                        <div class="chart-container" style="height: 220px;">
                                            <canvas id="chart-score-XII"></canvas>
                                        </div>
                                    </div>
                                    <div id="solution-XII" class="hidden pt-4 border-t border-slate-200 bg-red-50 p-4 rounded-md animate-pulse"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- REKAPITULASI NILAI VIEW -->
                    <div id="rekap-nilai-view" class="view hidden space-y-8">
                        <div class="card bg-white shadow-sm border border-slate-200">
                            <div class="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
                                <h3 class="card-title mb-0" data-lang="rekapNilai">Rekapitulasi Nilai</h3>
                                <select id="rekap-class-filter" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto text-sm focus:ring-2 focus:ring-indigo-500">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                        </div>
                        <div id="rekap-projek-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
                    </div>

                    <!-- Rapor Semester 1 -->
                    <div id="rapor-semester-1-view" class="view hidden">
                        <div class="card">
                            <div class="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center mb-6">
                                <div>
                                    <h3 class="card-title mb-1" data-lang="raporSemester1">Rapor Semester 1</h3>
                                    <p class="text-sm text-slate-500">Kalkulasi rata-rata otomatis dari seluruh projek.</p>
                                </div>
                                <div class="flex gap-2 w-full sm:w-auto">
                                    <select id="rapor-class-filter" class="p-2 border rounded-md bg-white form-select flex-1 sm:w-auto text-sm"></select>
                                    <button id="export-rapor-btn" class="py-2 px-4 rounded-md btn-secondary text-sm font-semibold flex items-center justify-center whitespace-nowrap">
                                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                        <span data-lang="exportExcel">Export</span>
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm border-collapse">
                                    <thead class="bg-slate-50 border-b border-slate-200">
                                        <tr>
                                            <th class="p-3 font-semibold text-slate-700">No</th>
                                            <th class="p-3 font-semibold text-slate-700">NIS</th>
                                            <th class="p-3 font-semibold text-slate-700">Nama Siswa</th>
                                            <th class="p-3 font-semibold text-slate-700 text-center">Jumlah Projek</th>
                                            <th class="p-3 font-semibold text-slate-700 text-center">Rata-Rata Akhir</th>
                                            <th class="p-3 font-semibold text-slate-700 text-center">Predikat</th>
                                            <th class="p-3 font-semibold text-slate-700">Keterangan</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rapor-table-body" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Missing Scores View -->
                    <div id="missing-scores-view" class="view hidden">
                        <div class="card">
                            <h3 class="card-title mb-4" data-lang="missingScoresTitle">Cek Nilai Kosong</h3>
                            <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-lg mb-6 flex items-start gap-3">
                                <i data-lucide="info" class="text-indigo-600 w-5 h-5 flex-shrink-0 mt-0.5"></i>
                                <p class="text-sm text-indigo-700">Fitur ini menampilkan siswa yang belum memiliki nilai pada projek tertentu.</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 items-end">
                                <div>
                                    <label class="block text-sm font-medium mb-1 text-slate-600">Jenjang</label>
                                    <select id="missing-level-filter" class="p-2 border rounded-md bg-white form-select w-full">
                                        <option value="">Pilih Jenjang</option>
                                        <option value="X">Kelas X</option>
                                        <option value="XI">Kelas XI</option>
                                        <option value="XII">Kelas XII</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 text-slate-600">Kelas</label>
                                    <select id="missing-class-filter" class="p-2 border rounded-md bg-white form-select w-full" disabled>
                                        <option value="">Semua Kelas</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 text-slate-600">Projek</label>
                                    <select id="missing-project-filter" class="p-2 border rounded-md bg-white form-select w-full" disabled>
                                        <option value="">Semua Projek</option>
                                    </select>
                                </div>
                                <button id="check-missing-btn" class="py-2 px-4 rounded-md btn-primary text-sm font-semibold flex items-center justify-center">
                                    <i data-lucide="search" class="w-4 h-4 mr-2"></i>
                                    <span>Tampilkan Siswa</span>
                                </button>
                            </div>
                            <div class="overflow-x-auto max-h-[60vh] overflow-y-auto">
                                <table class="w-full text-left text-sm border-collapse">
                                    <thead class="bg-slate-50 border-b border-slate-200 sticky top-0">
                                        <tr>
                                            <th class="p-3 font-semibold text-slate-700 w-16">No</th>
                                            <th class="p-3 font-semibold text-slate-700">Nama Siswa</th>
                                            <th class="p-3 font-semibold text-slate-700">Kelas</th>
                                            <th class="p-3 font-semibold text-slate-700">Projek yang Kosong</th>
                                            <th class="p-3 font-semibold text-slate-700 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="missing-scores-table-body" class="divide-y divide-slate-100">
                                        <tr>
                                            <td colspan="5" class="p-8 text-center text-slate-500 italic">Silakan pilih filter dan klik "Tampilkan Siswa"</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Input View (Menu) -->
                    <div id="data-input-view" class="view hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Attendance Card -->
                            <div id="go-to-attendance-input" class="card input-menu-card">
                                <div>
                                    <div class="flex items-center text-indigo-600 mb-4">
                                        <i data-lucide="user-check" class="w-8 h-8"></i>
                                        <h3 class="ml-4 text-xl font-semibold text-slate-800" data-lang="inputAttendance">Input Kehadiran</h3>
                                    </div>
                                    <p id="attendance-summary-text" class="text-slate-600 text-sm mb-4">Memuat ringkasan...</p>
                                </div>
                                <div class="flex justify-end items-center text-indigo-600 font-semibold">
                                    <span>Buka</span>
                                    <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
                                </div>
                            </div>
                            <!-- Score Card -->
                            <div id="go-to-score-input" class="card input-menu-card">
                                <div>
                                    <div class="flex items-center text-amber-600 mb-4">
                                        <i data-lucide="award" class="w-8 h-8"></i>
                                        <h3 class="ml-4 text-xl font-semibold text-slate-800" data-lang="inputScore">Input Nilai</h3>
                                    </div>
                                    <p id="score-summary-text" class="text-slate-600 text-sm mb-4">Memuat ringkasan...</p>
                                </div>
                                 <div class="flex justify-end items-center text-amber-600 font-semibold">
                                    <span>Buka</span>
                                    <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
                                </div>
                            </div>
                             <!-- Activity Card -->
                            <div id="go-to-activity-input" class="card input-menu-card">
                                <div>
                                    <div class="flex items-center text-emerald-600 mb-4">
                                        <i data-lucide="star" class="w-8 h-8"></i>
                                        <h3 class="ml-4 text-xl font-semibold text-slate-800" data-lang="inputActivity">Input Keaktifan</h3>
                                    </div>
                                    <p id="activity-summary-text" class="text-slate-600 text-sm mb-4">Memuat ringkasan...</p>
                                </div>
                                 <div class="flex justify-end items-center text-emerald-600 font-semibold">
                                    <span>Buka</span>
                                    <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Input View (With Import/Export) -->
                    <div id="attendance-input-view" class="view hidden">
                         <button id="back-to-data-input-from-attendance" class="inline-flex items-center gap-2 mb-4 px-3 py-2 text-sm font-medium text-slate-600 bg-white rounded-lg border border-slate-200 hover:bg-slate-100">
                             <i data-lucide="arrow-left" class="w-4 h-4"></i>
                             Kembali ke Menu Input
                         </button>
                         <div class="card">
                            <div class="flex flex-col xl:flex-row gap-4 justify-between xl:items-center">
                                <h3 class="card-title mb-0" data-lang="inputAttendance">Input Kehadiran</h3>
                                <div class="flex flex-wrap gap-2">
                                    <!-- Download Template Button -->
                                    <button id="download-attendance-template-btn" class="py-2 px-4 rounded-md btn-secondary text-sm font-semibold flex items-center justify-center bg-emerald-600 hover:bg-emerald-700">
                                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                        <span>Download Format</span>
                                    </button>
                                    <!-- Import Excel Button -->
                                    <button id="import-attendance-btn" class="py-2 px-4 rounded-md btn-secondary text-sm font-semibold flex items-center justify-center">
                                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                        <span data-lang="importAttendanceExcel">Import (Excel)</span>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-indigo-50 p-3 rounded-md border border-indigo-100 mb-4 mt-2">
                                <p class="text-xs text-indigo-700"><i data-lucide="info" class="w-3 h-3 inline mr-1"></i>Pilih <b>Kelas</b> dan <b>Tanggal</b> terlebih dahulu sebelum men-download format atau meng-import data.</p>
                            </div>
                             <div class="flex flex-col sm:flex-row gap-4 my-4">
                                <select id="input-attendance-class" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto">
                                    <!-- Options populated by JS -->
                                </select>
                                <input type="date" id="input-attendance-date" class="p-2 border rounded-md bg-white form-input w-full sm:w-auto">
                            </div>
                            <div class="mb-4">
                                <input type="text" id="attendance-student-search" class="p-2 border rounded-md w-full form-input" placeholder="Cari nama siswa...">
                            </div>
                            <div class="max-h-80 overflow-y-auto pr-2">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="border-b border-slate-200">
                                            <th class="p-2 text-slate-600" data-lang="studentName">Nama Siswa</th>
                                            <th class="p-2 text-slate-600" data-lang="status">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendance-input-table">
                                        <!-- Rows populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <button id="save-attendance" class="mt-4 px-4 py-2 rounded-md w-full btn-primary" data-lang="save">Simpan</button>

                            <div class="mt-8 pt-6 border-t border-slate-200">
                                <h4 class="text-lg font-semibold mb-2 text-slate-700" data-lang="exportAttendanceRange">Export Rekap Kehadiran</h4>
                                <div class="flex flex-col sm:flex-row gap-4 items-end">
                                    <div class="flex-1">
                                        <label for="export-start-date" class="block text-sm font-medium text-slate-600 mb-1">Tanggal Mulai</label>
                                        <input type="date" id="export-start-date" class="p-2 border rounded-md bg-white form-input w-full">
                                    </div>
                                    <div class="flex-1">
                                        <label for="export-end-date" class="block text-sm font-medium text-slate-600 mb-1">Tanggal Akhir</label>
                                        <input type="date" id="export-end-date" class="p-2 border rounded-md bg-white form-input w-full">
                                    </div>
                                    <button id="export-attendance-range-btn" class="py-2 px-4 rounded-md btn-primary text-sm font-semibold flex items-center justify-center">
                                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                        <span data-lang="exportExcel">Export ke Excel</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Activity Input View -->
                    <div id="activity-input-view" class="view hidden">
                         <button id="back-to-data-input-from-activity" class="inline-flex items-center gap-2 mb-4 px-3 py-2 text-sm font-medium text-slate-600 bg-white rounded-lg border border-slate-200 hover:bg-slate-100">
                             <i data-lucide="arrow-left" class="w-4 h-4"></i>
                             Kembali ke Menu Input
                         </button>
                         <div class="card">
                            <h3 class="card-title" data-lang="inputActivity">Input Keaktifan</h3>
                             <div class="flex flex-col sm:flex-row gap-4 my-4">
                                <select id="input-activity-class" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto"></select>
                            </div>
                            <div class="max-h-96 overflow-y-auto pr-2">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="border-b border-slate-200">
                                            <th class="p-2 text-slate-600" data-lang="studentName">Nama Siswa</th>
                                            <th class="p-2 text-slate-600">Skor Keaktifan (0-100)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="activity-input-table"></tbody>
                                </table>
                            </div>
                            <button id="save-activity" class="mt-4 px-4 py-2 rounded-md w-full btn-primary" data-lang="save">Simpan</button>
                        </div>
                    </div>

                    <!-- Score Input View (With Import/Export) -->
                    <div id="score-input-view" class="view hidden">
                        <button id="back-to-data-input-from-score" class="inline-flex items-center gap-2 mb-4 px-3 py-2 text-sm font-medium text-slate-600 bg-white rounded-lg border border-slate-200 hover:bg-slate-100">
                             <i data-lucide="arrow-left" class="w-4 h-4"></i>
                             Kembali ke Menu Input
                         </button>
                         <div class="card">
                            <div class="flex flex-col xl:flex-row gap-4 justify-between xl:items-center">
                                <h3 class="card-title" data-lang="inputScore">Input Nilai</h3>
                                <div class="flex flex-wrap gap-2">
                                    <!-- Download Template Button -->
                                    <button id="download-score-template-btn" class="py-2 px-4 rounded-md btn-secondary text-sm font-semibold flex items-center justify-center bg-emerald-600 hover:bg-emerald-700">
                                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                        <span>Download Format</span>
                                    </button>
                                    <!-- Import Scores Button -->
                                    <button id="import-scores-btn" class="mb-4 sm:mb-0 w-full sm:w-auto py-2 px-4 rounded-md btn-secondary text-sm font-semibold flex items-center justify-center">
                                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                        <span data-lang="importScoresExcel">Import Nilai (Excel)</span>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-indigo-50 p-3 rounded-md border border-indigo-100 mb-4 mt-2">
                                <p class="text-xs text-indigo-700"><i data-lucide="info" class="w-3 h-3 inline mr-1"></i>Pilih <b>Kelas</b> dan <b>Projek</b> terlebih dahulu. Format Excel akan menyesuaikan kriteria projek.</p>
                            </div>
                             <div class="flex flex-col sm:flex-row gap-4 my-4">
                                <select id="input-score-class" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto"></select>
                                <select id="input-score-project" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto"></select>
                                <select id="input-score-type" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto">
                                    <option value="personal" data-lang="personal">Personal</option>
                                    <option value="group" data-lang="group">Kelompok</option>
                                </select>
                            </div>
                            <div id="score-input-specific-filter-container" class="my-4"></div>
                            <div class="overflow-x-auto">
                                <div class="max-h-96 overflow-y-auto pr-2">
                                    <table class="w-full text-left">
                                        <thead id="score-input-table-head" class="border-b border-slate-200"></thead>
                                        <tbody id="score-input-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            <button id="save-scores" class="mt-4 px-4 py-2 rounded-md w-full btn-primary" data-lang="save">Simpan</button>
                        </div>
                    </div>

                    <!-- Input Management View -->
                    <div id="input-management-view" class="view hidden space-y-8">
                        <!-- Project Management -->
                        <div class="card">
                            <h3 class="card-title" data-lang="projectManagement">Manajemen Projek</h3>
                            <div class="grid md:grid-cols-2 gap-8">
                                <div class="space-y-4">
                                    <div>
                                        <label for="new-project-name" class="block text-sm font-medium mb-1 text-slate-600" data-lang="projectName">Nama Projek Baru</label>
                                        <input type="text" id="new-project-name" class="p-2 border rounded-md w-full form-input" placeholder="Contoh: Projek Sains Bab 3">
                                    </div>
                                    <div>
                                        <label for="new-project-level" class="block text-sm font-medium mb-1 text-slate-600" data-lang="projectLevel">Jenjang Kelas</label>
                                        <select id="new-project-level" class="p-2 border rounded-md w-full form-select">
                                            <option value="X">Kelas X</option>
                                            <option value="XI">Kelas XI</option>
                                            <option value="XII">Kelas XII</option>
                                            <option value="Semua">Semua Jenjang</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1 text-slate-600" data-lang="projectCriteria">Kriteria Penilaian</label>
                                        <div class="flex">
                                            <input type="text" id="new-project-criteria" class="p-2 border rounded-l-md w-full form-input" placeholder="Contoh: Kreativitas">
                                            <button id="add-project-criteria-btn" class="px-3 py-2 btn-secondary rounded-r-md"><i data-lucide="plus"></i></button>
                                        </div>
                                        <div id="new-project-criteria-list" class="mt-2 flex flex-wrap gap-2"></div>
                                    </div>
                                    <button id="save-new-project-btn" class="px-4 py-2 rounded-md w-full btn-primary" data-lang="addProject">Tambah Projek</button>
                                </div>
                                 <div>
                                     <h4 class="text-lg font-semibold mb-2 text-slate-700" data-lang="projectList">Daftar Projek</h4>
                                     <ul id="project-list-display" class="space-y-3 max-h-80 overflow-y-auto pr-2"></ul>
                                 </div>
                            </div>
                        </div>
                        <!-- Group Management -->
                        <div class="card">
                             <div class="flex flex-col sm:flex-row gap-4 mb-4 justify-between items-center">
                                <h3 class="card-title mb-0" data-lang="groupManagement">Manajemen Kelompok</h3>
                                <button id="import-groups-btn" class="w-full sm:w-auto py-2 px-4 rounded-md btn-secondary text-sm font-semibold flex items-center justify-center">
                                    <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                    <span data-lang="importGroupsExcel">Import Kelompok (Excel)</span>
                                </button>
                            </div>
                             <div class="flex flex-col sm:flex-row gap-4 mb-4">
                                <select id="group-mg-class-filter" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto"></select>
                                <select id="group-mg-project-filter" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto"></select>
                            </div>
                            <div class="grid md:grid-cols-2 gap-8">
                                <div>
                                    <h4 class="text-lg font-semibold mb-2 text-slate-700" data-lang="availableStudents">Siswa Tersedia</h4>
                                    <input type="text" id="available-student-search" placeholder="Cari nama siswa..." class="p-2 border rounded-md w-full form-input mb-2">
                                    <div id="available-students-container" class="space-y-2 max-h-96 overflow-y-auto pr-2 border rounded-md p-2 bg-slate-50"></div>
                                </div>
                                <div>
                                    <div class="flex mb-4">
                                        <input type="text" id="new-group-name" class="p-2 border rounded-l-md w-full form-input" placeholder="Nama Kelompok Baru">
                                        <button id="add-group-btn" class="px-4 py-2 btn-primary rounded-r-md flex items-center">
                                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                            <span data-lang="addGroup">Tambah</span>
                                        </button>
                                    </div>
                                    <div id="groups-list-container" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings View -->
                    <div id="settings-view" class="view hidden">
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <!-- Appearance (UPDATED with SAVE Button) -->
                            <div class="card">
                                <h3 class="card-title" data-lang="appearance">Tampilan</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1 text-slate-600" data-lang="appLogo">Logo Aplikasi</label>
                                        <input type="file" id="logo-upload" accept="image/*" class="text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1 text-slate-600" data-lang="appBackground">Background Aplikasi</label>
                                        <input type="file" id="background-upload" accept="image/*" class="text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1 text-slate-600" data-lang="themeColor">Warna Tema</label>
                                        <div class="flex items-center space-x-4 mt-2">
                                            <div>
                                                <label for="primary-color-picker" class="text-sm font-medium text-slate-500">Primer</label>
                                                <input type="color" id="primary-color-picker" class="w-full h-10 p-1 mt-1 border border-slate-300 rounded-md cursor-pointer">
                                            </div>
                                            <div>
                                                <label for="secondary-color-picker" class="text-sm font-medium text-slate-500">Sekunder</label>
                                                <input type="color" id="secondary-color-picker" class="w-full h-10 p-1 mt-1 border border-slate-300 rounded-md cursor-pointer">
                                            </div>
                                        </div>
                                    </div>
                                    <button id="save-appearance-btn" class="mt-4 px-4 py-2 rounded-md w-full btn-primary text-sm font-semibold flex items-center justify-center">
                                        <i data-lucide="save" class="w-4 h-4 mr-2"></i> Simpan Tampilan
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Admin Management -->
                            <div class="card">
                                <h3 class="card-title mb-4" data-lang="adminManagement">Manajemen Admin</h3>
                                <ul id="admin-list" class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-1">
                                    <!-- Admin list populated here -->
                                </ul>
                                <div class="bg-slate-50 p-4 rounded-lg border border-slate-100">
                                    <h4 class="text-sm font-semibold text-slate-700 mb-3">Tambah Admin Baru</h4>
                                    <div class="space-y-3">
                                        <input type="email" id="new-admin-email" placeholder="Email admin" class="p-2 border rounded-md w-full form-input text-sm">
                                        <input type="password" id="new-admin-password" placeholder="Password" class="p-2 border rounded-md w-full form-input text-sm">
                                        <button id="add-admin-btn" class="px-4 py-2 rounded-md w-full btn-primary text-sm flex items-center justify-center">
                                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Tambah
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Reset -->
                            <div class="card">
                                <h3 class="card-title mb-4" data-lang="dataManagement">Manajemen Data</h3>
                                <div class="space-y-4">
                                    <div class="bg-amber-50 p-4 rounded-lg border border-amber-100">
                                        <h4 class="text-sm font-bold text-amber-800 mb-2 flex items-center"><i data-lucide="database" class="w-4 h-4 mr-2"></i> Import Data</h4>
                                        <button id="import-btn" class="w-full text-left p-3 bg-white border border-amber-200 text-amber-900 rounded-md hover:bg-amber-100 transition flex items-center shadow-sm"> 
                                            <i data-lucide="upload" class="w-4 h-4 mr-2 text-amber-600"></i> 
                                            <span class="text-sm font-medium" data-lang="importStudentData">Import Data Siswa (Excel)</span>
                                        </button>
                                        <p class="text-xs text-amber-700 mt-2 px-1" data-lang="importFormat"><i data-lucide="info" class="w-3 h-3 inline mr-1"></i>Format Excel: No, NIS, Nama, Kelas</p>
                                    </div>
                                    
                                    <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                                        <h4 class="text-sm font-bold text-red-800 mb-2 flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Zona Bahaya</h4>
                                        <button class="reset-btn w-full text-left p-3 bg-white border border-red-200 text-red-700 rounded-md hover:bg-red-600 hover:text-white transition flex items-center shadow-sm group" onclick="handleReset(event)" data-type="all"> 
                                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2 group-hover:text-white text-red-500"></i> 
                                            <span class="text-sm font-medium" data-lang="resetAllData">Reset Semua Data Aplikasi</span>
                                        </button>
                                        <p class="text-xs text-red-700 mt-2 px-1">Menghapus seluruh siswa, nilai, dan absensi.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Guide View -->
                    <div id="guide-view" class="view hidden">
                        <div class="card prose max-w-none prose-slate">
                            <h2 data-lang="guideTitle">Panduan Penggunaan Mozzart Education</h2>
                            
                            <h3 data-lang="guide1Title">Langkah 1: Pengaturan Awal</h3>
                            <p data-lang="guide1Text">Pertama kali, buka menu 'Pengaturan'. Gunakan 'Import Data Siswa' untuk mengunggah daftar siswa dari file Excel.</p>

                            <h3 data-lang="guide2Title">Langkah 2: Membuat Projek</h3>
                            <p data-lang="guide2TextNew">Buka menu 'Manajemen Input'. Tambahkan projek beserta kriteria penilaiannya.</p>

                            <h3 data-lang="guide3Title">Langkah 3: Mencatat Kehadiran</h3>
                            <p data-lang="guide3TextNew">Masuk ke 'Input Data' -> 'Input Kehadiran'. Anda bisa input manual atau gunakan tombol 'Download Format' untuk mengisi di Excel lalu upload kembali dengan 'Import (Excel)'.</p>

                            <h3 data-lang="guide4Title">Langkah 4: Menginput Nilai</h3>
                            <p data-lang="guide4Text">Buka 'Input Data' -> 'Input Nilai'. Pilih projek, lalu gunakan 'Download Format' untuk mendapatkan template Excel yang sesuai kriteria projek. Isi nilai, lalu upload kembali.</p>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <!-- Modals (Confirmation, Edit Project, Missing Score, Project Detail) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm"><h3 id="modal-title" class="text-lg font-bold mb-4 text-slate-800">Konfirmasi</h3><p id="modal-text" class="mb-6 text-slate-600">Apakah Anda yakin?</p><div class="flex justify-end space-x-3"><button id="modal-cancel" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">Batal</button><button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700" data-lang="confirm">Yakin</button></div></div></div>

    <div id="edit-project-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg"><h3 id="edit-project-modal-title" class="text-lg font-bold mb-4 text-slate-800">Edit Projek</h3><div class="space-y-4 mb-4"><div><label class="block text-sm font-medium mb-1 text-slate-600">Nama Projek</label><input type="text" id="edit-project-name" class="p-2 border rounded-md w-full form-input"></div><div><label class="block text-sm font-medium mb-1 text-slate-600">Jenjang Kelas</label><select id="edit-project-level" class="p-2 border rounded-md w-full form-select"><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option><option value="Semua">Semua Jenjang</option></select></div></div><div class="space-y-4"><div><label class="block text-sm font-medium mb-1 text-slate-600">Kriteria Penilaian</label><div class="flex mb-2"><input type="text" id="edit-project-new-criteria-input" class="p-2 border rounded-l-md w-full form-input" placeholder="Contoh: Presentasi"><button id="edit-project-add-criteria-btn" class="px-3 py-2 btn-secondary rounded-r-md"><i data-lucide="plus"></i></button></div><div id="edit-project-criteria-list" class="flex flex-wrap gap-2 p-2 bg-slate-50 rounded border border-slate-200 min-h-[50px]"></div></div></div><div class="flex justify-end space-x-3 mt-6"><button id="edit-project-modal-cancel" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">Batal</button><button id="edit-project-modal-save" class="px-4 py-2 btn-primary text-white rounded-md">Simpan Perubahan</button></div></div></div>

    <div id="missing-score-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[60] p-4"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md transform transition-all scale-100"><div class="flex justify-between items-center mb-4 border-b pb-3"><h3 class="text-lg font-bold text-slate-800">Input Nilai</h3><button onclick="closeMissingScoreModal()" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="mb-4 bg-indigo-50 p-3 rounded-md border border-indigo-100"><p class="text-sm text-indigo-800 font-semibold"><span id="ms-modal-student-name"></span></p><p class="text-xs text-indigo-600 mt-1">Projek: <span id="ms-modal-project-name"></span></p></div><form id="ms-modal-form" class="space-y-4 max-h-[60vh] overflow-y-auto pr-1"><input type="hidden" id="ms-student-id"><input type="hidden" id="ms-project-id"><input type="hidden" id="ms-class-name"><div id="ms-modal-inputs" class="space-y-3"></div></form><div class="flex justify-end space-x-3 mt-6 pt-3 border-t"><button onclick="closeMissingScoreModal()" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-md hover:bg-slate-200 text-sm font-medium">Batal</button><button onclick="saveMissingScore()" class="px-4 py-2 btn-primary text-white rounded-md text-sm font-semibold flex items-center"><i data-lucide="save" class="w-4 h-4 mr-2"></i> Simpan Nilai</button></div></div></div>

    <div id="project-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[70] p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col"><div class="flex justify-between items-center p-6 border-b"><div><h3 class="text-xl font-bold text-slate-800" id="detail-modal-title">Detail Nilai Projek</h3><p class="text-sm text-slate-500" id="detail-modal-subtitle">Kelas - Projek</p></div><button onclick="closeProjectDetail()" class="text-slate-400 hover:text-red-500 transition"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="flex-1 overflow-auto p-6"><table class="w-full text-left text-sm border-collapse"><thead class="bg-slate-50 border-b sticky top-0 z-10"><tr id="detail-table-head"></tr></thead><tbody id="detail-table-body" class="divide-y divide-slate-100"></tbody></table></div><div class="p-4 border-t bg-slate-50 text-right"><button onclick="closeProjectDetail()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 font-medium">Tutup</button></div></div></div>

    <input type="file" id="generic-file-input" class="hidden" accept=".xlsx, .xls, .csv">

    <script>
    document.addEventListener('DOMContentLoaded', async function () {
        // --- 1. GLOBAL VARIABLES & TRANSLATIONS ---
        const SUPABASE_URL = 'https://taeodevmwvalajqjbpaq.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhZW9kZXZtd3ZhbGFqcWpicGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NDYxNjUsImV4cCI6MjA3MjAyMjE2NX0.-IX9xVUlrkKow0CKUahPCEx2fGUHqnNpkcpoFxBW4G4';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const DATA_ROW_ID = 1; 

        let appData = {};
        let selectedGroupId = null;
        let tempNewCriteriaForEdit = [];
        let fileImportCallback = null;
        let charts = {}; 
        let tempProjectCriteria = [];
        let pendingSettings = {};
        
        // MOVED TRANSLATIONS TO TOP SCOPE
        const translations = {
              id: {
                appTitle: "Mozzart Education", dashboard: "Dasbor Kelas", rekapNilai: "Rekapitulasi Nilai", dataInput: "Input Data", inputManagement: "Manajemen Input", settings: "Pengaturan", guide: "Panduan", language: "Bahasa:", attendanceRecap: "Rekapitulasi Kehadiran", class: "Per Kelas", individual: "Individual", daily: "Harian", weekly: "Mingguan", monthly: "Bulanan", scoreRating: "Rating Nilai Siswa", topStudents: "Peringkat Teratas", attendanceToday: "Kehadiran Hari Ini", inputAttendance: "Input Kehadiran", inputActivity: "Input Keaktifan", studentName: "Nama Siswa", status: "Status", save: "Simpan", inputScore: "Input Nilai", personal: "Personal", group: "Kelompok", addCriteria: "+ Tambah Kriteria", appearance: "Tampilan", appLogo: "Logo Aplikasi", appBackground: "Background Aplikasi", themeColor: "Warna Tema", adminManagement: "Manajemen Admin", add: "Tambah", dataManagement: "Manajemen Data", importStudentData: "Import Data Siswa (Excel)", importFormat: "Format: no, nis, nama, kelas", resetAllData: "Reset Semua Data Aplikasi", guideTitle: "Panduan Penggunaan Mozzart Education", guide1Title: "Langkah 1: Pengaturan Awal", guide1Text: "Pertama kali, buka menu 'Pengaturan'. Gunakan 'Import Data Siswa' untuk mengunggah daftar siswa dari file Excel.", guide2Title: "Langkah 2: Membuat Projek", guide2TextNew: "Buka menu 'Manajemen Input'. Tambahkan projek beserta kriteria penilaiannya.", guide3Title: "Langkah 3: Mencatat Kehadiran", guide3TextNew: "Masuk ke 'Input Data' -> 'Input Kehadiran'. Anda bisa input manual atau gunakan tombol 'Download Format' untuk mengisi di Excel lalu upload kembali dengan 'Import (Excel)'.", guide4Title: "Langkah 4: Menginput Nilai", guide4Text: "Buka 'Input Data' -> 'Input Nilai'. Pilih projek, lalu gunakan 'Download Format' untuk mendapatkan template Excel yang sesuai kriteria projek. Isi nilai, lalu upload kembali.", guide5Title: "Langkah 5: Memantau Progres", guide5TextNew: "Gunakan 'Dasbor Kelas' untuk melihat rekapitulasi.", cancel: "Batal", confirm: "Yakin", present: "Hadir", sick: "Sakit", permit: "Izin", absent: "Alpa", score: "Nilai", rank: "Peringkat", projectManagement: "Manajemen Projek", projectName: "Nama Projek Baru", projectCriteria: "Scoring Criteria", addProject: "Add Project", projectList: "Project List", projectLevel: "Class Level", groupManagement: "Group Management", addGroup: "Add", searchStudent: "Search & add student...", importingData: "Importing data...", resetingData: "Resetting data...", classStats: "Class Statistics", totalStudents: "Total Students", activeProjects: "Active Projects", viewDetailsProgress: "View Progress Details", viewDetailsRating: "View Full Ratings", viewDetailsAttendance: "Input & Detail Kehadiran", classComparison: "Inter-Class Comparison", bestRankingInfo: "Informasi Peringkat Terbaik", bestClass: "Kelas Terbaik", bestStudent: "Siswa Terbaik", attendance: "Kehadiran", averageScore: "Rata-rata Nilai", totalScore: "Total Score", logout: "Logout", password: "Password", newAdminEmail: "New admin email", newAdminPassword: "New password", exportExcel: "Export to Excel", importAttendanceExcel: "Import (Excel)", exportAttendanceExcel: "Export (Excel)", exportAttendanceRange: "Export Attendance Recap", exportAttendanceDesc: "Select a date range to export (max 6 months).", importScoresExcel: "Import Nilai (Excel)", importGroupsExcel: "Import Groups (Excel)", importingGroups: "Importing group data...", availableStudents: "Available Students", collapseMenu: "Collapse menu", teacherInsight: "Student Activity Insights", mostActiveStudents: "Most Active Students", needsAttentionStudents: "Students Needing Attention", attendanceInsight: "Attendance Insight", attendanceImprovement: "Best Attendance", attendanceDecline: "Needs Attention", raporSemester1: "Semester 1 Report", finalGrade: "Final Grade", predicate: "Predicate", description: "Description", missingScores: "Cek Data Nilai", missingScoresTitle: "Cek Data Nilai"
            }
        };

        let currentMissingScoreStudentId = null;
        let currentMissingScoreProjectId = null;
        let currentMissingScoreClassName = null;
        let editingProjectId = null;

        const loginForm = document.getElementById('login-form');
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginError = document.getElementById('login-error');


        // --- 2. CORE FUNCTION DEFINITIONS ---

        async function checkSupabaseRLS() {
            const TEST_ROW_ID = 999999;
            const { error: insertError } = await supabaseClient
                .from('class_management_data')
                .upsert({ id: TEST_ROW_ID, app_data: { test: true } });
            if (insertError) return false;
            await supabaseClient.from('class_management_data').delete().eq('id', TEST_ROW_ID);
            return true;
        }

        async function loadData() {
            try {
                const { data, error } = await supabaseClient.from('class_management_data').select('app_data').eq('id', DATA_ROW_ID).single();
                if (data && data.app_data) {
                    appData = data.app_data;
                    if (!appData.admins || appData.admins.length === 0) appData.admins = getInitialDataStructure().admins;
                } else {
                    appData = getInitialDataStructure();
                }
            } catch (error) {
                appData = getInitialDataStructure();
            }
        }

        async function saveData() {
            const { error } = await supabaseClient.from('class_management_data').upsert({ id: DATA_ROW_ID, app_data: appData });
            if (error) alert('Gagal menyimpan data ke database.');
        }

        function getInitialDataStructure() {
             return { students: {}, projects: [], scores: {}, attendance: {}, activityScores: {}, groups: {}, admins: [{ email: 'admin@gmail.com', password: 'admin', protected: true }], settings: { logoUrl: 'https://placehold.co/40x40/1e293b/ffffff?text=ME', backgroundUrl: '', theme: { primary: '#1e293b', secondary: '#4f46e5' } } };
        }

        async function initApp() {
            lucide.createIcons();
            const rlsOk = await checkSupabaseRLS();
            if (!rlsOk) return;
            applySettings();
            setupEventListeners();
            refreshAllViews();
            changeLanguage('id'); // Fix: translations is now defined
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.id !== 'logout-btn') {
                    link.addEventListener('click', (e) => { e.preventDefault(); if(link.dataset.view) navigateTo(link.dataset.view); });
                }
            });
            document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); appContainer.classList.add('hidden'); loginContainer.classList.remove('hidden'); document.getElementById('password').value = ''; loginError.classList.add('hidden'); });
            
            document.getElementById('lang-id').addEventListener('click', () => changeLanguage('id'));
            document.getElementById('lang-en').addEventListener('click', () => changeLanguage('en'));
            document.getElementById('menu-toggle').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('main-sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); });
            document.getElementById('sidebar-overlay').addEventListener('click', () => { document.getElementById('main-sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden'); });

            document.getElementById('rekap-class-filter').addEventListener('change', renderRekapitulasiView);
            document.getElementById('rapor-class-filter').addEventListener('change', renderRaporSemester1);
            document.getElementById('export-rapor-btn').addEventListener('click', exportRaporToExcel);
            document.getElementById('missing-level-filter').addEventListener('change', populateMissingScoresFilters);
            document.getElementById('check-missing-btn').addEventListener('click', checkMissingScores);

            document.getElementById('go-to-attendance-input').addEventListener('click', () => navigateTo('attendance-input'));
            document.getElementById('go-to-score-input').addEventListener('click', () => navigateTo('score-input'));
            document.getElementById('go-to-activity-input').addEventListener('click', () => navigateTo('activity-input'));
            document.getElementById('back-to-data-input-from-attendance').addEventListener('click', () => navigateTo('data-input'));
            document.getElementById('back-to-data-input-from-score').addEventListener('click', () => navigateTo('data-input'));
            document.getElementById('back-to-data-input-from-activity').addEventListener('click', () => navigateTo('data-input'));

            document.getElementById('input-attendance-class').addEventListener('change', () => populateAttendanceInputTable(''));
            document.getElementById('attendance-student-search').addEventListener('keyup', (e) => populateAttendanceInputTable(e.target.value));
            document.getElementById('export-attendance-range-btn').addEventListener('click', exportAttendanceByDateRange);
            document.getElementById('save-attendance').addEventListener('click', saveAttendanceData);
            
            document.getElementById('download-attendance-template-btn').addEventListener('click', downloadAttendanceTemplate);
            document.getElementById('import-attendance-btn').addEventListener('click', () => { fileImportCallback = processAttendanceImport; document.getElementById('generic-file-input').click(); });
            document.getElementById('download-score-template-btn').addEventListener('click', downloadScoreTemplate);
            document.getElementById('import-scores-btn').addEventListener('click', () => { fileImportCallback = processScoreImport; document.getElementById('generic-file-input').click(); });

            document.getElementById('input-activity-class').addEventListener('change', populateActivityInputTable);
            document.getElementById('save-activity').addEventListener('click', saveActivityData);

            document.getElementById('input-score-class').addEventListener('change', updateScoreProjectFilterAndTable);
            document.getElementById('input-score-type').addEventListener('change', updateScoreProjectFilterAndTable);
            document.getElementById('input-score-project').addEventListener('change', () => { document.getElementById('score-input-specific-filter-container').innerHTML = ''; populateScoreInputTable(); });
            document.getElementById('save-scores').addEventListener('click', saveScoreData);

            document.getElementById('add-project-criteria-btn').addEventListener('click', addTempCriteria);
            document.getElementById('save-new-project-btn').addEventListener('click', saveNewProject);
            document.getElementById('add-group-btn').addEventListener('click', addNewGroup);
            document.getElementById('group-mg-class-filter').addEventListener('change', (e) => { const ps = document.getElementById('group-mg-project-filter'); populateProjectFilters(ps, e.target.value); ps.dispatchEvent(new Event('change')); });
            document.getElementById('group-mg-project-filter').addEventListener('change', renderGroupManagementUI);
            document.getElementById('available-student-search').addEventListener('keyup', renderGroupManagementUI);

            document.getElementById('logo-upload').addEventListener('change', (e) => handleImageUpload(e, 'logoUrl'));
            document.getElementById('background-upload').addEventListener('change', (e) => handleImageUpload(e, 'backgroundUrl'));
            document.getElementById('primary-color-picker').addEventListener('change', (e) => handleColorChange(e, 'primary'));
            document.getElementById('secondary-color-picker').addEventListener('change', (e) => handleColorChange(e, 'secondary'));
            document.getElementById('save-appearance-btn').addEventListener('click', saveAppearanceSettings);
            document.getElementById('add-admin-btn').addEventListener('click', addAdmin);
            document.getElementById('import-btn').addEventListener('click', handleStudentImport);
            document.getElementById('import-groups-btn').addEventListener('click', handleGroupImport);
            
            document.getElementById('generic-file-input').addEventListener('change', (e) => { if (fileImportCallback) fileImportCallback(e); e.target.value = ''; });
            document.querySelectorAll('.reset-btn').forEach(button => button.addEventListener('click', handleReset));
            document.getElementById('modal-cancel').addEventListener('click', () => document.getElementById('confirmation-modal').classList.add('hidden'));

            document.getElementById('edit-project-add-criteria-btn').addEventListener('click', addTempCriteriaForEdit);
            document.getElementById('edit-project-modal-cancel').addEventListener('click', () => { document.getElementById('edit-project-modal').classList.add('hidden'); editingProjectId = null; });
            document.getElementById('edit-project-modal-save').addEventListener('click', saveEditedProject);
        }

        // --- HELPER FUNCTIONS ---

        function handleImageUpload(event, key) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    pendingSettings[key] = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function handleColorChange(event, key) {
            const color = event.target.value;
            if (!pendingSettings.theme) {
                pendingSettings.theme = appData.settings.theme ? { ...appData.settings.theme } : { primary: '#1e293b', secondary: '#4f46e5' };
            }
            pendingSettings.theme[key] = color;
        }

        async function saveAppearanceSettings() {
            if (Object.keys(pendingSettings).length === 0) {
                alert("Tidak ada perubahan untuk disimpan.");
                return;
            }
            appData.settings = {
                ...appData.settings,
                ...pendingSettings,
                theme: {
                    ...appData.settings.theme,
                    ...(pendingSettings.theme || {})
                }
            };
            pendingSettings = {};
            applySettings();
            await saveData();
            alert("Tampilan berhasil disimpan dan diterapkan!");
        }

        function applySettings() {
             if(appData.settings?.logoUrl) {
                 document.querySelectorAll('#app-logo, #login-logo').forEach(el => el.src = appData.settings.logoUrl);
             }
             if(appData.settings?.backgroundUrl) {
                 document.body.style.backgroundImage = `url('${appData.settings.backgroundUrl}')`;
             } else {
                 document.body.style.backgroundImage = 'none';
             }
             if(appData.settings?.theme) {
                 const root = document.documentElement;
                 root.style.setProperty('--primary-color', appData.settings.theme.primary);
                 root.style.setProperty('--secondary-color', appData.settings.theme.secondary);
                 const activeLink = document.querySelector('.nav-link.active');
                 if(activeLink) {
                     activeLink.style.backgroundColor = appData.settings.theme.primary;
                 }
                 document.getElementById('primary-color-picker').value = appData.settings.theme.primary;
                 document.getElementById('secondary-color-picker').value = appData.settings.theme.secondary;
             }
        }

        function applyLoginScreenSettings() { 
            if(appData.settings?.logoUrl) document.getElementById('login-logo').src = appData.settings.logoUrl; 
        }

        function updateScoreProjectFilterAndTable() {
            document.getElementById('score-input-specific-filter-container').innerHTML = '';
            const className = document.getElementById('input-score-class').value;
            populateProjectFilters(document.getElementById('input-score-project'), className);
            document.getElementById('input-score-project').dispatchEvent(new Event('change'));
        }

        function populateProjectFilters(selectEl, className) {
            selectEl.innerHTML = '';
            const originalValue = selectEl.value;
            if (!className || !appData.projects) { selectEl.innerHTML = `<option value="">Pilih Projek</option>`; return; }
            const classLevel = getLevelFromClassName(className);
            const relevantProjects = appData.projects.filter(p => p.level === 'Semua' || p.level === classLevel);
            if (relevantProjects.length === 0) { selectEl.innerHTML = `<option value="">Tidak ada projek</option>`; } 
            else { selectEl.innerHTML = `<option value="">Pilih Projek</option>`; relevantProjects.forEach(p => selectEl.innerHTML += `<option value="${p.id}">${p.name}</option>`); }
            selectEl.value = originalValue;
        }

        function getLevelFromClassName(className) {
            if (typeof className !== 'string') return null;
            className = className.toUpperCase().trim(); // Improved robust check
            if (className.startsWith('XII') || className.startsWith('12')) return 'XII';
            if (className.startsWith('XI') || className.startsWith('11')) return 'XI';
            if (className.startsWith('X') || className.startsWith('10')) return 'X';
            return null;
        }

        function navigateTo(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`${viewId}-view`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active', 'text-white'));
            document.querySelectorAll('.nav-link').forEach(l => { 
                if(l.dataset.view !== viewId) { l.classList.add('text-slate-600'); l.style.backgroundColor = 'transparent'; }
            });
            const activeLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
            if (activeLink) { 
                activeLink.classList.add('active', 'text-white'); 
                activeLink.classList.remove('text-slate-600');
                activeLink.style.backgroundColor = appData.settings?.theme?.primary || '#1e293b';
            }
            // Use translations safely
            const titleKey = viewId;
            const fallbackKey = document.querySelector(`.nav-link[data-view="${viewId}"] span`)?.dataset.lang;
            const titleText = translations['id'][titleKey] || translations['id'][fallbackKey] || "Mozzart Education";
            document.getElementById('view-title').textContent = titleText;
            
            refreshAllViews();
        }

        function refreshAllViews() {
            const allClassNames = appData.students ? Object.keys(appData.students).sort() : [];
            const allSelects = document.querySelectorAll('select[id$="-class-filter"], #input-attendance-class, #input-activity-class, #input-score-class, #group-mg-class-filter, #rekap-class-filter, #rapor-class-filter');
            
            allSelects.forEach(select => {
                const current = select.value;
                select.innerHTML = allClassNames.length === 0 ? `<option value="">Tidak Ada Kelas</option>` : `<option value="">Pilih Kelas</option>`;
                allClassNames.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; select.appendChild(opt); });
                if (allClassNames.includes(current)) select.value = current;
                else if (allClassNames.length > 0 && !current) select.value = allClassNames[0];
            });

            renderDashboardCharts();
            renderRekapitulasiView();
            renderRaporSemester1();
            renderProjectList();
            renderAdminList();
            // Trigger change events
            allSelects.forEach(s => s.dispatchEvent(new Event('change')));
        }

        function createOrUpdateChart(id, config) {
            if(charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, config);
        }
        
        function getEmptyChartConfig() { 
            return { type: 'doughnut', data: { labels: ["Tidak ada data"], datasets: [{ data: [1], backgroundColor: ['#e2e8f0'], borderWidth: 0 }] }, options: { events: [], responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false }, datalabels: { display: false } }, cutout: '70%' } }; 
        }

        function renderDashboardCharts() {
            ['X', 'XI', 'XII'].forEach(level => {
                let attCounts = { hadir: 0, sakit: 0, izin: 0, alpa: 0 };
                let scoreCounts = { baik: 0, kurang: 0, perlu: 0 };
                const classNames = appData.students ? Object.keys(appData.students) : [];
                const levelClasses = classNames.filter(c => getLevelFromClassName(c) === level);
                
                if (levelClasses.length === 0) {
                     createOrUpdateChart(`chart-att-${level}`, getEmptyChartConfig());
                     createOrUpdateChart(`chart-score-${level}`, getEmptyChartConfig());
                     document.getElementById(`solution-${level}`).classList.add('hidden');
                     return;
                }

                levelClasses.forEach(cls => {
                    const students = appData.students[cls] || [];
                    const attData = appData.attendance?.[cls]?.daily || {};
                    Object.values(attData).forEach(day => Object.values(day).forEach(s => { if(attCounts[s]!==undefined) attCounts[s]++; }));

                    students.forEach(student => {
                        let totalScore = 0, pCount = 0;
                        (appData.projects||[]).forEach(p => {
                            if(p.level === level || p.level === 'Semua') {
                                const s = appData.scores?.[p.id]?.[student.id];
                                if(s && s.total > 0) { totalScore += s.total; pCount++; }
                            }
                        });
                        if(pCount>0) { const avg = totalScore/pCount; if(avg>=83) scoreCounts.baik++; else if(avg>=75) scoreCounts.kurang++; else scoreCounts.perlu++; }
                    });
                });

                const attTotal = attCounts.hadir+attCounts.sakit+attCounts.izin+attCounts.alpa;
                const scoreTotal = scoreCounts.baik+scoreCounts.kurang+scoreCounts.perlu;
                const alpaPercent = attTotal > 0 ? (attCounts.alpa/attTotal)*100 : 0;
                const perluPercent = scoreTotal > 0 ? (scoreCounts.perlu/scoreTotal)*100 : 0;

                const solDiv = document.getElementById(`solution-${level}`);
                let solHTML = '';
                if(alpaPercent > 0) solHTML += `<div class="mb-3 p-3 bg-red-50 border-l-4 border-red-500 rounded-r-md"><h5 class="font-bold text-red-800 text-xs uppercase tracking-wide mb-1 flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Tingkat Alpa: ${alpaPercent.toFixed(1)}%</h5><p class="text-xs text-red-700">Periksa kehadiran siswa.</p></div>`;
                if(perluPercent > 0) solHTML += `<div class="p-3 bg-orange-50 border-l-4 border-orange-500 rounded-r-md"><h5 class="font-bold text-orange-800 text-xs uppercase tracking-wide mb-1 flex items-center"><i data-lucide="book-open" class="w-4 h-4 mr-2"></i> Nilai Perlu Perhatian: ${perluPercent.toFixed(1)}%</h5><p class="text-xs text-orange-700">Adakan remedial.</p></div>`;
                
                if(solHTML) { solDiv.innerHTML = solHTML; solDiv.className = "mt-4 pt-4 border-t border-slate-200 block animate-in fade-in"; }
                else if(attTotal>0||scoreTotal>0) { solDiv.innerHTML = `<div class="p-3 bg-emerald-50 border-l-4 border-emerald-500 rounded-r-md"><h5 class="font-bold text-emerald-800 text-xs uppercase tracking-wide flex items-center"><i data-lucide="check-circle" class="w-4 h-4 mr-2"></i> Kelas Kondusif</h5></div>`; solDiv.className = "mt-4 pt-4 border-t border-slate-200 block animate-in fade-in"; }
                else { solDiv.className = "hidden"; }

                createOrUpdateChart(`chart-att-${level}`, { type: 'pie', data: { labels: ['Hadir', 'Sakit', 'Izin', 'Alpa'], datasets: [{ data: [attCounts.hadir, attCounts.sakit, attCounts.izin, attCounts.alpa], backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#ef4444'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15, font: {size: 11} } }, datalabels: { color: '#fff', formatter: (val, ctx) => { let sum=0; ctx.chart.data.datasets[0].data.map(d=>sum+=d); return (val*100/sum).toFixed(0)+"%"; }, font: { weight: 'bold', size: 10 } } } }, plugins: [ChartDataLabels] });
                createOrUpdateChart(`chart-score-${level}`, { type: 'pie', data: { labels: ['Baik', 'Kurang', 'Perlu Perhatian'], datasets: [{ data: [scoreCounts.baik, scoreCounts.kurang, scoreCounts.perlu], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15, font: {size: 11} } }, datalabels: { color: '#fff', formatter: (val, ctx) => { let sum=0; ctx.chart.data.datasets[0].data.map(d=>sum+=d); return (val*100/sum).toFixed(0)+"%"; }, font: { weight: 'bold', size: 10 } } } }, plugins: [ChartDataLabels] });
            });
            setTimeout(() => lucide.createIcons(), 100);
        }

        function renderRekapitulasiView() {
            const className = document.getElementById('rekap-class-filter').value;
            const container = document.getElementById('rekap-projek-container');
            container.innerHTML = '';
            if (!className) { container.innerHTML = '<p class="text-center text-slate-500 col-span-2">Silakan pilih kelas.</p>'; return; }
            const classLevel = getLevelFromClassName(className);
            const projects = appData.projects ? appData.projects.filter(p => p.level === classLevel || p.level === 'Semua') : [];
            if (projects.length === 0) { container.innerHTML = '<p class="text-center text-slate-500 col-span-2">Belum ada projek.</p>'; return; }
            
            projects.forEach(project => {
                const projectScores = appData.scores?.[project.id] || {};
                const students = appData.students[className] || [];
                const ranked = students.map(s => ({ ...s, totalScore: projectScores[s.id]?.total || 0 })).sort((a, b) => b.totalScore - a.totalScore).slice(0, 5);
                
                let rows = '';
                if(ranked.length>0 && ranked[0].totalScore > 0) {
                    ranked.forEach((s, i) => { if(s.totalScore>0) rows += `<tr class="border-b last:border-0 border-slate-50"><td class="py-2 text-center w-8 font-bold text-slate-400">${i+1}</td><td class="py-2 font-medium text-slate-700">${s.name}</td><td class="py-2 text-right font-bold text-indigo-600">${s.totalScore}</td></tr>`; });
                } else { rows = '<tr><td colspan="3" class="py-4 text-center text-slate-400 italic text-sm">Belum ada nilai.</td></tr>'; }
                
                const card = document.createElement('div');
                card.className = "card bg-white border border-slate-200 rounded-lg p-5 hover:shadow-md transition";
                card.innerHTML = `<div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3"><h4 class="font-bold text-lg text-slate-800">${project.name}</h4><span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded">Top 5</span></div><table class="w-full text-sm mb-4"><tbody>${rows}</tbody></table><button onclick="openProjectDetail('${project.id}', '${className}')" class="w-full py-2 bg-indigo-50 text-indigo-600 rounded-md text-sm font-semibold hover:bg-indigo-100 transition flex items-center justify-center"><i data-lucide="list" class="w-4 h-4 mr-2"></i> Lihat Selengkapnya</button>`;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function renderRaporSemester1() {
            const className = document.getElementById('rapor-class-filter').value;
            const tbody = document.getElementById('rapor-table-body');
            tbody.innerHTML = '';
            if(!className) return;
            
            const students = appData.students[className] || [];
            const classLevel = getLevelFromClassName(className);
            const projects = appData.projects.filter(p => p.level === classLevel || p.level === 'Semua');
            
            students.forEach((s, idx) => {
                let total = 0, count = 0;
                projects.forEach(p => {
                    const scoreData = appData.scores?.[p.id]?.[s.id];
                    // FIX: Check if score data exists and has a total property that is a number (including 0)
                    if(scoreData && typeof scoreData.total === 'number') { 
                         total += scoreData.total; 
                         count++; 
                    }
                });
                const avg = count > 0 ? Math.round(total/count) : 0;
                let pred='-', ket='-';
                if(count > 0) {
                    if(avg>=90) { pred='A'; ket='Sangat Baik'; }
                    else if(avg>=80) { pred='B'; ket='Baik'; }
                    else if(avg>=70) { pred='C'; ket='Cukup'; }
                    else { pred='D'; ket='Kurang'; }
                }
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="p-3 text-slate-500">${idx+1}</td><td class="p-3 text-slate-500 font-mono text-xs">${s.nis||'-'}</td><td class="p-3 font-medium text-slate-800">${s.name}</td><td class="p-3 text-center">${count}</td><td class="p-3 text-center font-bold">${avg||'-'}</td><td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs font-bold ${pred==='A'?'bg-emerald-100 text-emerald-700':(pred==='D'?'bg-red-100 text-red-700':'bg-slate-100 text-slate-700')}">${pred}</span></td><td class="p-3 text-slate-600">${ket}</td>`;
                tbody.appendChild(tr);
            });
        }

        function populateAttendanceInputTable(search) {
            const className = document.getElementById('input-attendance-class').value;
            const tbody = document.getElementById('attendance-input-table');
            tbody.innerHTML = '';
            if(!className) return;
            const students = appData.students[className] || [];
            const date = document.getElementById('input-attendance-date').value;
            const saved = date && appData.attendance?.[className]?.daily?.[date] ? appData.attendance[className].daily[date] : {};

            students.filter(s => s.name.toLowerCase().includes(search.toLowerCase())).forEach(s => {
                const st = saved[s.id] || '';
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-100";
                tr.innerHTML = `<td class="p-2 text-slate-700">${s.name}</td><td class="p-2"><div class="flex gap-1">
                    ${['Hadir','Sakit','Izin','Alpa'].map(l => `<label class="cursor-pointer"><input type="radio" name="att-${s.id}" value="${l.toLowerCase()}" class="peer hidden" ${st===l.toLowerCase()?'checked':''}><span class="px-3 py-1 rounded text-xs border peer-checked:bg-slate-800 peer-checked:text-white hover:bg-slate-100">${l[0]}</span></label>`).join('')}
                </div></td>`;
                tbody.appendChild(tr);
            });
        }

        function populateScoreInputTable() {
            const className = document.getElementById('input-score-class').value;
            const projectId = document.getElementById('input-score-project').value;
            const thead = document.getElementById('score-input-table-head');
            const tbody = document.getElementById('score-input-table-body');
            thead.innerHTML = ''; tbody.innerHTML = '';
            
            if(!className || !projectId) return;
            const project = appData.projects.find(p => p.id === projectId);
            const students = appData.students[className] || [];
            
            let headHTML = `<th class="p-2 text-slate-600 w-10">No</th><th class="p-2 text-slate-600">Nama</th>`;
            project.criteria.forEach(c => headHTML += `<th class="p-2 text-slate-600 w-24">${c}</th>`);
            thead.innerHTML = `<tr>${headHTML}</tr>`;

            students.forEach((s, i) => {
                const sc = appData.scores?.[projectId]?.[s.id]?.details || {};
                let row = `<td class="p-2 text-slate-500">${i+1}</td><td class="p-2 font-medium">${s.name}</td>`;
                project.criteria.forEach(c => row += `<td class="p-2"><input type="number" class="w-full p-1 border rounded text-center score-input-field" data-student="${s.id}" data-criteria="${c}" value="${sc[c]||''}" placeholder="0"></td>`);
                const tr = document.createElement('tr'); tr.innerHTML = row; tbody.appendChild(tr);
            });
        }

        async function saveAttendanceData() {
            const cls = document.getElementById('input-attendance-class').value;
            const date = document.getElementById('input-attendance-date').value;
            if(!cls || !date) { alert('Pilih kelas dan tanggal.'); return; }
            if(!appData.attendance) appData.attendance={}; if(!appData.attendance[cls]) appData.attendance[cls]={daily:{}}; if(!appData.attendance[cls].daily) appData.attendance[cls].daily={};
            if(!appData.attendance[cls].daily[date]) appData.attendance[cls].daily[date]={};
            
            const inputs = document.querySelectorAll('input[type="radio"]:checked');
            inputs.forEach(inp => { const sid = inp.name.split('-')[1]; appData.attendance[cls].daily[date][sid] = inp.value; });
            await saveData(); alert('Absensi disimpan.');
        }

        async function saveScoreData() {
            const cls = document.getElementById('input-score-class').value;
            const pid = document.getElementById('input-score-project').value;
            if(!cls || !pid) return;
            if(!appData.scores) appData.scores={}; if(!appData.scores[pid]) appData.scores[pid]={};
            
            const inputs = document.querySelectorAll('.score-input-field');
            const tempScores = {};
            inputs.forEach(inp => {
                const sid = inp.dataset.student; const crit = inp.dataset.criteria; const val = parseInt(inp.value)||0;
                if(!tempScores[sid]) tempScores[sid] = {};
                tempScores[sid][crit] = val;
            });
            
            Object.keys(tempScores).forEach(sid => {
                const details = tempScores[sid];
                const vals = Object.values(details);
                const total = vals.length > 0 ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : 0;
                appData.scores[pid][sid] = { total, details };
            });
            await saveData(); alert('Nilai disimpan.'); renderDashboardCharts();
        }

        function populateMissingScoresFilters() {
            const level = document.getElementById('missing-level-filter').value;
            const classSelect = document.getElementById('missing-class-filter');
            const projectSelect = document.getElementById('missing-project-filter');
            
            classSelect.innerHTML = '<option value="">Semua Kelas</option>';
            projectSelect.innerHTML = '<option value="">Semua Projek</option>';
            
            if (!level) {
                classSelect.disabled = true;
                projectSelect.disabled = true;
                return;
            }

            classSelect.disabled = false;
            projectSelect.disabled = false;

            const allClassNames = Object.keys(appData.students).sort();
            allClassNames.forEach(cls => {
                if (getLevelFromClassName(cls) === level) {
                    classSelect.innerHTML += `<option value="${cls}">${cls}</option>`;
                }
            });

            if (appData.projects) {
                appData.projects.forEach(p => {
                    if (p.level === level || p.level === 'Semua') {
                        projectSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    }
                });
            }
        }

        function checkMissingScores() {
            const level = document.getElementById('missing-level-filter').value;
            const selectedClass = document.getElementById('missing-class-filter').value;
            const selectedProject = document.getElementById('missing-project-filter').value;
            const tbody = document.getElementById('missing-scores-table-body');

            if (!level) {
                alert("Silakan pilih jenjang terlebih dahulu.");
                return;
            }

            tbody.innerHTML = '';
            
            let classesToCheck = [];
            if (selectedClass) {
                classesToCheck = [selectedClass];
            } else {
                classesToCheck = Object.keys(appData.students).filter(cls => getLevelFromClassName(cls) === level);
            }

            let projectsToCheck = [];
            if (selectedProject) {
                const p = appData.projects.find(proj => proj.id === selectedProject);
                if(p) projectsToCheck = [p];
            } else {
                projectsToCheck = appData.projects.filter(p => p.level === level || p.level === 'Semua');
            }

            if (projectsToCheck.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-500 italic">Tidak ada projek yang ditemukan untuk kriteria ini.</td></tr>`;
                 return;
            }

            let foundMissing = false;
            let counter = 1;

            classesToCheck.forEach(cls => {
                const students = appData.students[cls] || [];
                students.forEach(student => {
                    projectsToCheck.forEach(project => {
                        const hasScore = appData.scores && 
                                       appData.scores[project.id] && 
                                       appData.scores[project.id][student.id];
                        
                        if (!hasScore) {
                            foundMissing = true;
                            const tr = document.createElement('tr');
                            tr.className = "border-b border-slate-50 hover:bg-slate-50";
                            tr.innerHTML = `
                                <td class="p-3 text-slate-500">${counter++}</td>
                                <td class="p-3 font-medium text-slate-800">${student.name}</td>
                                <td class="p-3 text-slate-600 text-sm">${cls}</td>
                                <td class="p-3 text-indigo-600 font-medium text-sm">${project.name}</td>
                                <td class="p-3 text-center">
                                    <button onclick="openMissingScoreModal('${student.id}', '${project.id}', '${cls}')" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-md hover:bg-indigo-100 text-xs font-bold transition flex items-center justify-center mx-auto">
                                        <i data-lucide="plus-circle" class="w-3 h-3 mr-1"></i> Input
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        }
                    });
                });
            });

            if (!foundMissing) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-emerald-600 font-medium"><i data-lucide="check-circle" class="w-6 h-6 mx-auto mb-2"></i>Semua siswa lengkap memiliki nilai!</td></tr>`;
            }
            lucide.createIcons();
        }

        window.openMissingScoreModal = function(sid, pid, cname) {
            const student = appData.students[cname].find(s => s.id === parseInt(sid) || s.id === sid);
            const project = appData.projects.find(p => p.id === pid);

            if (!student || !project) return;

            currentMissingScoreStudentId = sid;
            currentMissingScoreProjectId = pid;
            currentMissingScoreClassName = cname;

            document.getElementById('ms-modal-student-name').textContent = student.name;
            document.getElementById('ms-modal-project-name').textContent = project.name;

            const inputsContainer = document.getElementById('ms-modal-inputs');
            inputsContainer.innerHTML = '';

            project.criteria.forEach(crit => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase">${crit}</label>
                    <input type="number" class="w-full p-2 border rounded-md form-input text-sm ms-criteria-input" data-criteria="${crit}" placeholder="0-100" min="0" max="100">
                `;
                inputsContainer.appendChild(div);
            });

            document.getElementById('missing-score-modal').classList.remove('hidden');
        };

        window.closeMissingScoreModal = function() {
            document.getElementById('missing-score-modal').classList.add('hidden');
            currentMissingScoreStudentId = null;
            currentMissingScoreProjectId = null;
        };

        window.saveMissingScore = async function() {
            if (!currentMissingScoreStudentId || !currentMissingScoreProjectId) return;

            const inputs = document.querySelectorAll('.ms-criteria-input');
            const details = {};
            let sum = 0;
            let count = 0;

            inputs.forEach(input => {
                const crit = input.dataset.criteria;
                let val = parseInt(input.value);
                if (isNaN(val)) val = 0;
                if (val > 100) val = 100;
                if (val < 0) val = 0;
                
                details[crit] = val;
                sum += val;
                count++;
            });

            const total = count > 0 ? Math.round(sum / count) : 0;

            if (!appData.scores) appData.scores = {};
            if (!appData.scores[currentMissingScoreProjectId]) appData.scores[currentMissingScoreProjectId] = {};
            
            appData.scores[currentMissingScoreProjectId][currentMissingScoreStudentId] = {
                total: total,
                details: details
            };

            await saveData();
            checkMissingScores();
            renderDashboardCharts();
            closeMissingScoreModal();
        };
        
        window.openProjectDetail = function(pid, cname) {
            const p = appData.projects.find(x=>x.id===pid); const s = appData.students[cname]||[];
            document.getElementById('detail-modal-title').textContent = p.name;
            let h = `<th class="p-3">No</th><th class="p-3">Nama</th>`; p.criteria.forEach(c=>h+=`<th class="p-3 text-center">${c}</th>`); h+=`<th class="p-3 text-center">Rata2</th>`;
            document.getElementById('detail-table-head').innerHTML = h;
            const sc = appData.scores?.[pid]||{};
            let b = ''; s.forEach((std, i) => { const d = sc[std.id]||{total:0,details:{}}; let r = `<td class="p-3 text-slate-500">${i+1}</td><td class="p-3 font-medium">${std.name}</td>`; p.criteria.forEach(c=>r+=`<td class="p-3 text-center">${d.details?.[c]||'-'}</td>`); r+=`<td class="p-3 text-center font-bold">${d.total||'-'}</td>`; b+=`<tr>${r}</tr>`; });
            document.getElementById('detail-table-body').innerHTML = b;
            document.getElementById('project-detail-modal').classList.remove('hidden');
        };
        window.closeProjectDetail = function() { document.getElementById('project-detail-modal').classList.add('hidden'); };

        function exportAttendanceByDateRange() { alert('Fitur export range tersedia.'); }
        function populateActivityInputTable() {}
        function saveActivityData() {}
        function addNewGroup() {}
        function renderGroupManagementUI() {}
        function handleGroupImport() {}
        
        function renderAdminList() {
            const list = document.getElementById('admin-list');
            list.innerHTML = '';
            appData.admins.forEach((admin, index) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center p-3 bg-slate-50 rounded-md border border-slate-200 transition hover:shadow-sm";
                li.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 shadow-sm border border-indigo-200">
                            <i data-lucide="user" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-slate-800">${admin.email}</p>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${admin.protected ? 'bg-indigo-100 text-indigo-800' : 'bg-slate-200 text-slate-600'}">
                                ${admin.protected ? 'Super Admin' : 'Admin'}
                            </span>
                        </div>
                    </div>
                    ${!admin.protected ? `<button onclick="deleteAdmin('${admin.email}')" class="text-slate-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition" title="Hapus Admin"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                `;
                list.appendChild(li);
            });
            lucide.createIcons();
        }

        function addAdmin() {
            const email = document.getElementById('new-admin-email').value;
            const password = document.getElementById('new-admin-password').value;
            if(!email || !password) { alert("Email dan Password wajib diisi"); return; }
            
            appData.admins.push({ email, password, protected: false });
            saveData();
            renderAdminList();
            document.getElementById('new-admin-email').value = '';
            document.getElementById('new-admin-password').value = '';
            alert("Admin berhasil ditambahkan");
        }

        function deleteAdmin(email) {
            if(confirm("Hapus admin ini?")) {
                appData.admins = appData.admins.filter(a => a.email !== email);
                saveData();
                renderAdminList();
            }
        }

        function handleStudentImport() {
            fileImportCallback = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet); 
                    
                    let count = 0;
                    json.forEach(row => {
                        const keys = Object.keys(row);
                        const namaKey = keys.find(k => k.toLowerCase() === 'nama');
                        const nisKey = keys.find(k => k.toLowerCase() === 'nis');
                        const kelasKey = keys.find(k => k.toLowerCase() === 'kelas');

                        const nama = row[namaKey];
                        const nis = row[nisKey];
                        const kelas = row[kelasKey];
                        
                        if(nama && kelas) {
                            const cleanClass = String(kelas).trim(); 
                            if(!appData.students[cleanClass]) appData.students[cleanClass] = [];
                            
                            const exists = appData.students[cleanClass].some(s => s.name.toLowerCase() === String(nama).toLowerCase());
                            if(!exists) {
                                appData.students[cleanClass].push({
                                    id: Date.now() + Math.random(),
                                    name: String(nama).trim(),
                                    nis: nis ? String(nis).trim() : ''
                                });
                                count++;
                            }
                        }
                    });
                    
                    await saveData();
                    refreshAllViews();
                    alert(`Berhasil mengimpor ${count} siswa.`);
                };
                reader.readAsArrayBuffer(file);
            };
            document.getElementById('generic-file-input').click();
        }

        function handleReset(e) {
            // Check if e exists because onclick="handleReset()" might pass undefined
            const type = e ? e.currentTarget.dataset.type : 'all'; 
            // In HTML onclick="handleReset(event)" is needed, but we can default
            if(confirm("PERINGATAN: Ini akan menghapus SELURUH data siswa, nilai, dan absensi. Tindakan ini tidak dapat dibatalkan. Lanjutkan?")) {
                const admins = appData.admins;
                const settings = appData.settings;
                appData = getInitialDataStructure();
                appData.admins = admins;
                appData.settings = settings;
                saveData();
                refreshAllViews();
                alert("Semua data telah direset.");
            }
        }

        function exportRaporToExcel() {}
        
        function changeLanguage(lang) {
            document.querySelectorAll('[data-lang]').forEach(el => { 
                if(translations[lang][el.dataset.lang]) el.textContent = translations[lang][el.dataset.lang]; 
            });
        }

        function renderProjectList() {
            const list = document.getElementById('project-list-display');
            list.innerHTML = '';
            
            if (!appData.projects || appData.projects.length === 0) {
                list.innerHTML = '<li class="text-center text-slate-400 text-sm italic py-4 bg-slate-50 rounded-md border border-dashed border-slate-300">Belum ada projek yang ditambahkan.</li>';
                return;
            }

            appData.projects.forEach(project => {
                const li = document.createElement('li');
                li.className = "bg-white border border-slate-200 rounded-md p-3 hover:shadow-md transition-shadow group";
                const levelColors = { 'X': 'bg-blue-100 text-blue-700', 'XI': 'bg-purple-100 text-purple-700', 'XII': 'bg-emerald-100 text-emerald-700', 'Semua': 'bg-slate-100 text-slate-700' };
                const badgeColor = levelColors[project.level] || 'bg-slate-100 text-slate-700';
                const criteriaTags = project.criteria.map(c => `<span class="text-xs bg-slate-50 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200">${c}</span>`).join(' ');

                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold px-2 py-0.5 rounded ${badgeColor}">${project.level}</span>
                                <h4 class="font-semibold text-slate-800">${project.name}</h4>
                            </div>
                            <div class="flex flex-wrap gap-1 mt-2">${criteriaTags}</div>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="openEditProject('${project.id}')" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition" title="Edit Projek"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="deleteProject('${project.id}')" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition" title="Hapus Projek"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });
            lucide.createIcons();
        }

        function addTempCriteria() {
            const input = document.getElementById('new-project-criteria');
            const val = input.value.trim();
            if (val) { tempProjectCriteria.push(val); renderTempCriteriaList(); input.value = ''; input.focus(); }
        }
        function renderTempCriteriaList() {
            document.getElementById('new-project-criteria-list').innerHTML = tempProjectCriteria.map((c, i) => `<span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs flex items-center gap-1">${c} <button onclick="removeTempCriteria(${i})" class="hover:text-red-600"></button></span>`).join('');
        }
        function removeTempCriteria(index) { tempProjectCriteria.splice(index, 1); renderTempCriteriaList(); }
        
        async function saveNewProject() {
            const name = document.getElementById('new-project-name').value.trim();
            const level = document.getElementById('new-project-level').value;
            if (!name) { alert('Nama projek wajib diisi'); return; }
            if (tempProjectCriteria.length === 0) { alert('Minimal satu kriteria penilaian wajib diisi'); return; }
            const newProject = { id: 'PROJ_' + Date.now(), name: name, level: level, criteria: [...tempProjectCriteria] };
            if (!appData.projects) appData.projects = [];
            appData.projects.push(newProject);
            document.getElementById('new-project-name').value = ''; tempProjectCriteria = []; renderTempCriteriaList();
            await saveData(); renderProjectList(); refreshAllViews(); alert('Projek berhasil ditambahkan!');
        }

        function deleteProject(id) {
            if(confirm("Apakah Anda yakin ingin menghapus projek ini?")) {
                appData.projects = appData.projects.filter(p => p.id !== id);
                if(appData.scores && appData.scores[id]) delete appData.scores[id];
                saveData().then(() => {
                    renderProjectList(); refreshAllViews(); alert('Projek berhasil dihapus.');
                });
            }
        }

        function openEditProject(id) {
            const project = appData.projects.find(p => p.id === id); if(!project) return;
            editingProjectId = id; document.getElementById('edit-project-name').value = project.name; document.getElementById('edit-project-level').value = project.level;
            tempNewCriteriaForEdit = [...project.criteria]; renderEditCriteriaList();
            document.getElementById('edit-project-modal').classList.remove('hidden');
        }

        function addTempCriteriaForEdit() {
            const input = document.getElementById('edit-project-new-criteria-input'); const val = input.value.trim();
            if(val) { tempNewCriteriaForEdit.push(val); renderEditCriteriaList(); input.value = ''; input.focus(); }
        }
        function renderEditCriteriaList() {
            document.getElementById('edit-project-criteria-list').innerHTML = tempNewCriteriaForEdit.map((c, i) => `<span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs flex items-center gap-1 border border-indigo-200">${c} <button onclick="removeEditTempCriteria(${i})" class="hover:text-red-600 font-bold ml-1"></button></span>`).join('');
        }
        function removeEditTempCriteria(index) { tempNewCriteriaForEdit.splice(index, 1); renderEditCriteriaList(); }

        async function saveEditedProject() {
            if(!editingProjectId) return;
            const newName = document.getElementById('edit-project-name').value.trim(); const newLevel = document.getElementById('edit-project-level').value;
            if(!newName) { alert('Nama projek tidak boleh kosong'); return; }
            if(tempNewCriteriaForEdit.length === 0) { alert('Kriteria tidak boleh kosong'); return; }
            const projectIndex = appData.projects.findIndex(p => p.id === editingProjectId);
            if(projectIndex !== -1) {
                appData.projects[projectIndex].name = newName; appData.projects[projectIndex].level = newLevel; appData.projects[projectIndex].criteria = [...tempNewCriteriaForEdit];
                await saveData(); renderProjectList(); refreshAllViews(); document.getElementById('edit-project-modal').classList.add('hidden'); editingProjectId = null; alert('Perubahan berhasil disimpan');
            }
        }

        // --- NEW IMPORTER FUNCTIONS RESTORED ---
        
        function downloadAttendanceTemplate() {
            const selectedClass = document.getElementById('input-attendance-class').value;
            if (!selectedClass) { alert('Pilih kelas terlebih dahulu.'); return; }
            
            const students = appData.students[selectedClass] || [];
            if (students.length === 0) { alert('Tidak ada siswa di kelas ini.'); return; }

            const data = [];
            data.push(['No', 'NIS', 'Nama Siswa', 'Status (hadir/sakit/izin/alpa)']); 
            
            students.forEach((s, index) => {
                data.push([index + 1, s.nis || '', s.name, '']);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Absensi");
            worksheet['!cols'] = [{wch: 5}, {wch: 15}, {wch: 30}, {wch: 30}];
            XLSX.writeFile(workbook, `Template_Absensi_${selectedClass}.xlsx`);
        }

        async function processAttendanceImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                if (jsonData.length > 1) jsonData.shift(); 

                const selectedClass = document.getElementById('input-attendance-class').value;
                const selectedDate = document.getElementById('input-attendance-date').value;

                if (!selectedClass || !selectedDate) { alert('Pastikan kelas dan tanggal sudah dipilih.'); return; }
                
                if (!appData.attendance) appData.attendance = {};
                if (!appData.attendance[selectedClass]) appData.attendance[selectedClass] = { daily: {} };
                if (!appData.attendance[selectedClass].daily) appData.attendance[selectedClass].daily = {};
                if (!appData.attendance[selectedClass].daily[selectedDate]) appData.attendance[selectedClass].daily[selectedDate] = {};

                let updateCount = 0;
                const students = appData.students[selectedClass] || [];

                jsonData.forEach(row => {
                    const nis = row[1] ? String(row[1]).trim() : '';
                    const name = row[2] ? String(row[2]).trim() : '';
                    let status = row[3] ? String(row[3]).toLowerCase().trim() : '';

                    if (!['hadir', 'sakit', 'izin', 'alpa'].includes(status)) return;

                    const student = students.find(s => (s.nis && String(s.nis) === nis) || (s.name.toLowerCase() === name.toLowerCase()));

                    if (student) {
                        appData.attendance[selectedClass].daily[selectedDate][student.id] = status;
                        updateCount++;
                    }
                });

                await saveData();
                populateAttendanceInputTable(document.getElementById('attendance-student-search').value);
                alert(`Berhasil mengimpor data kehadiran untuk ${updateCount} siswa.`);
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadScoreTemplate() {
            const selectedClass = document.getElementById('input-score-class').value;
            const selectedProjectId = document.getElementById('input-score-project').value;

            if (!selectedClass || !selectedProjectId) { alert('Pilih kelas dan projek terlebih dahulu.'); return; }

            const project = appData.projects.find(p => p.id === selectedProjectId);
            const students = appData.students[selectedClass] || [];
            
            if (!project) return;
            if (students.length === 0) { alert('Tidak ada siswa di kelas ini.'); return; }

            const data = [];
            const headers = ['No', 'NIS', 'Nama Siswa', ...project.criteria];
            data.push(headers);

            students.forEach((s, index) => {
                const row = [index + 1, s.nis || '', s.name];
                project.criteria.forEach(() => row.push('')); 
                data.push(row);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Nilai");
            
            const wscols = [{wch: 5}, {wch: 15}, {wch: 30}];
            project.criteria.forEach(() => wscols.push({wch: 15}));
            worksheet['!cols'] = wscols;

            XLSX.writeFile(workbook, `Template_Nilai_${project.name}_${selectedClass}.xlsx`);
        }

        async function processScoreImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                const headers = jsonData[0]; 

                const selectedClass = document.getElementById('input-score-class').value;
                const selectedProjectId = document.getElementById('input-score-project').value;

                if (!selectedClass || !selectedProjectId) { alert('Pastikan kelas dan projek sudah dipilih.'); return; }
                
                const project = appData.projects.find(p => p.id === selectedProjectId);
                if(!project) return;

                if (!appData.scores) appData.scores = {};
                if (!appData.scores[selectedProjectId]) appData.scores[selectedProjectId] = {};

                let updateCount = 0;
                const students = appData.students[selectedClass] || [];

                const criteriaIndices = {};
                project.criteria.forEach(crit => {
                    const idx = headers.findIndex(h => String(h).trim().toLowerCase() === crit.toLowerCase());
                    if (idx !== -1) criteriaIndices[crit] = idx;
                });

                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;

                    const nis = row[1] ? String(row[1]).trim() : '';
                    const name = row[2] ? String(row[2]).trim() : '';
                    const student = students.find(s => (s.nis && String(s.nis) === nis) || (s.name.toLowerCase() === name.toLowerCase()));

                    if (student) {
                        let scoreSum = 0;
                        let details = {};
                        let validCriteriaCount = 0;

                        project.criteria.forEach(crit => {
                            const idx = criteriaIndices[crit];
                            if (idx !== undefined) {
                                let val = parseFloat(row[idx]);
                                if (isNaN(val)) val = 0;
                                if (val > 100) val = 100;
                                if (val < 0) val = 0;
                                details[crit] = val;
                                scoreSum += val;
                                validCriteriaCount++;
                            } else { details[crit] = 0; }
                        });

                        const total = validCriteriaCount > 0 ? Math.round(scoreSum / validCriteriaCount) : 0;
                        appData.scores[selectedProjectId][student.id] = { total: total, details: details };
                        updateCount++;
                    }
                }

                await saveData();
                populateScoreInputTable();
                alert(`Berhasil mengimpor nilai untuk ${updateCount} siswa.`);
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 4. WINDOW EXPORTS ---
        window.deleteProject = deleteProject;
        window.openEditProject = openEditProject;
        window.removeTempCriteria = removeTempCriteria;
        window.removeEditTempCriteria = removeEditTempCriteria;
        window.deleteAdmin = deleteAdmin;
        window.openMissingScoreModal = openMissingScoreModal;
        window.closeMissingScoreModal = closeMissingScoreModal;
        window.saveMissingScore = saveMissingScore;
        window.openProjectDetail = openProjectDetail;
        window.closeProjectDetail = closeProjectDetail;
        window.handleReset = handleReset;

        // --- 5. EXECUTION LOGIC ---
        await loadData();
        applyLoginScreenSettings();

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            const admin = appData.admins.find(a => a.email === email && a.password === password);
            if (admin) {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                await initApp();
            } else {
                loginError.classList.remove('hidden');
            }
        });

    });
    </script>
</body>
</html>
