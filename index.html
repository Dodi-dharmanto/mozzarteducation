<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mozzart Education - Manajemen Siswa</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1e293b;   /* slate-800 */
            --secondary-color: #4f46e5; /* indigo-600 */
            --background-color: #f1f5f9; /* slate-100 */
            --text-color: #334155;      /* slate-700 */
            --sidebar-bg: #ffffff;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }
        .sidebar-icon { stroke-width: 1.5; }
        .chart-container { position: relative; height: 200px; width: 100%; }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .form-input, .form-select { border-color: #cbd5e1; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus, .form-select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); outline: none; }
        .btn-primary { background-color: var(--primary-color); color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #334155; }
        .btn-secondary { background-color: var(--secondary-color); color: white; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #4338ca; }
        .card { background-color: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05); border: 1px solid #e2e8f0; transition: all 0.2s ease-in-out; }
        .card:hover { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07); }
        .card-title { font-size: 1.125rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem; }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link:not(.active):hover { transform: translateX(4px); background-color: #f1f5f9; }
        .input-menu-card { display: flex; flex-direction: column; justify-content: space-between; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s ease-in-out; }
        .input-menu-card:hover { border-color: var(--secondary-color); transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07); }
    </style>
</head>
<body class="text-slate-700">
    <!-- Login Container -->
    <div id="login-container" class="flex items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg m-4">
            <div class="text-center">
                <img id="login-logo" src="https://placehold.co/60x60/1e293b/ffffff?text=ME" alt="Mozzart Education Logo" class="mx-auto h-14 w-14 rounded-xl">
                <h2 class="mt-6 text-3xl font-bold text-slate-900" data-lang="appTitle">Mozzart Education</h2>
                <p class="mt-2 text-sm text-slate-600">Silakan masuk untuk melanjutkan</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div><label for="email-address" class="sr-only">Email</label><input id="email-address" name="email" type="email" required class="appearance-none rounded-t-md relative block w-full px-3 py-2 border border-slate-300 placeholder-slate-500 text-slate-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm form-input" placeholder="Email address"></div>
                    <div><label for="password" class="sr-only">Password</label><input id="password" name="password" type="password" required class="appearance-none rounded-b-md relative block w-full px-3 py-2 border border-slate-300 placeholder-slate-500 text-slate-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm form-input" placeholder="Password"></div>
                </div>
                 <div id="login-error" class="text-red-500 text-sm text-center hidden">Email atau kata sandi salah.</div>
                <div><button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-slate-800 hover:bg-slate-900 focus:outline-none btn-primary">Masuk</button></div>
            </form>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <div class="relative min-h-screen md:flex backdrop-blur-xl bg-slate-100/30">
            <!-- Sidebar -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
            <aside id="main-sidebar" class="fixed inset-y-0 left-0 bg-white/80 w-64 flex-col transition-transform duration-300 border-r border-slate-200 z-30 transform -translate-x-full md:translate-x-0 md:flex">
                <div class="flex items-center h-20 border-b border-slate-200 px-4 app-logo-container">
                    <img id="app-logo" src="https://placehold.co/40x40/1e293b/ffffff?text=ME" class="h-10 w-10 rounded-lg flex-shrink-0" alt="App Logo">
                    <h1 data-lang="appTitle" class="text-lg font-bold ml-3 text-slate-800 app-title-text">Mozzart Education</h1>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a href="#" class="nav-link active flex items-center p-3 rounded-lg text-white" data-view="dashboard" style="background-color: var(--primary-color);">
                        <i data-lucide="layout-dashboard" class="sidebar-icon"></i><span data-lang="dashboard" class="ml-4 nav-text">Dasbor Kelas</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="rekap-nilai">
                        <i data-lucide="file-spreadsheet" class="sidebar-icon"></i><span data-lang="rekapNilai" class="ml-4 nav-text">Rekapitulasi Nilai</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="rapor-semester">
                        <i data-lucide="book-open-check" class="sidebar-icon"></i><span data-lang="raporSemester" class="ml-4 nav-text">Nilai Rapor Semester</span>
                    </a>
                    <!-- MENU BARU: E-Rapor -->
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="e-rapor">
                        <i data-lucide="award" class="sidebar-icon"></i><span data-lang="eRapor" class="ml-4 nav-text">Nilai E-Rapor</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="missing-scores">
                        <i data-lucide="alert-circle" class="sidebar-icon"></i><span data-lang="missingScores" class="ml-4 nav-text">Cek Nilai Kosong</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="data-input">
                        <i data-lucide="edit-3" class="sidebar-icon"></i><span data-lang="dataInput" class="ml-4 nav-text">Input Data</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="input-management">
                        <i data-lucide="folder-plus" class="sidebar-icon"></i><span data-lang="inputManagement" class="ml-4 nav-text">Manajemen Input</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="settings">
                        <i data-lucide="settings" class="sidebar-icon"></i><span data-lang="settings" class="ml-4 nav-text">Pengaturan</span>
                    </a>
                     <a href="#" class="nav-link flex items-center p-3 rounded-lg text-slate-600" data-view="guide">
                        <i data-lucide="book-open" class="sidebar-icon"></i><span data-lang="guide" class="ml-4 nav-text">Panduan</span>
                    </a>
                </nav>
                <div class="p-4 border-t border-slate-200">
                    <a href="#" id="logout-btn" class="nav-link flex items-center p-3 rounded-lg text-slate-600 hover:bg-red-100 hover:text-red-600">
                        <i data-lucide="log-out" class="sidebar-icon"></i><span data-lang="logout" class="ml-4 nav-text">Keluar</span>
                    </a>
                </div>
            </aside>

            <!-- Main Content -->
            <main id="main-content" class="flex-1 flex flex-col overflow-hidden transition-all duration-300 md:ml-64">
                <header class="h-20 flex items-center justify-between px-4 md:px-8 border-b border-slate-200 bg-white/60 backdrop-blur-sm">
                    <div class="flex items-center">
                        <button id="menu-toggle" class="md:hidden p-2 mr-2 rounded-md text-slate-600 hover:bg-slate-100">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h2 id="view-title" data-lang="dashboard" class="text-xl sm:text-2xl font-semibold text-slate-800">Dasbor Kelas</h2>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <span class="mr-2 text-sm font-medium text-slate-600" data-lang="language">Bahasa:</span>
                            <div class="flex rounded-md shadow-sm">
                                <button id="lang-id" class="px-3 py-1 text-sm rounded-l-md bg-slate-800 text-white font-semibold">ID</button>
                                <button id="lang-en" class="px-3 py-1 text-sm rounded-r-md bg-slate-200 text-slate-700">EN</button>
                            </div>
                        </div>
                    </div>
                </header>
                <div class="flex-1 p-4 md:p-8 overflow-y-auto">
                    
                    <!-- Dashboard View -->
                    <div id="dashboard-view" class="view">
                        <div class="grid grid-cols-1 gap-6">
                            <!-- Level X -->
                            <div class="card">
                                <h3 class="card-title text-indigo-700 border-b pb-2 mb-4 flex justify-between">
                                    <span>Jenjang Kelas X</span>
                                    <span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-full">Statistik Semester Berjalan</span>
                                </h3>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div class="flex flex-col">
                                        <h4 class="text-sm font-semibold text-center text-slate-600 mb-3">Grafik Kehadiran</h4>
                                        <div class="chart-container"><canvas id="chart-att-X"></canvas></div>
                                    </div>
                                    <div class="flex flex-col justify-center space-y-4">
                                        <div id="stats-X" class="bg-slate-50 rounded-lg p-4 border border-slate-100"></div>
                                        <div class="pt-4 border-t border-slate-100">
                                            <h4 class="text-sm font-semibold text-slate-600 mb-2">Perkembangan Nilai</h4>
                                            <div class="chart-container" style="height: 150px;"><canvas id="chart-score-X"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Level XI -->
                            <div class="card">
                                <h3 class="card-title text-indigo-700 border-b pb-2 mb-4 flex justify-between">
                                    <span>Jenjang Kelas XI</span>
                                    <span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-full">Statistik Semester Berjalan</span>
                                </h3>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div class="flex flex-col">
                                        <h4 class="text-sm font-semibold text-center text-slate-600 mb-3">Grafik Kehadiran</h4>
                                        <div class="chart-container"><canvas id="chart-att-XI"></canvas></div>
                                    </div>
                                    <div class="flex flex-col justify-center space-y-4">
                                        <div id="stats-XI" class="bg-slate-50 rounded-lg p-4 border border-slate-100"></div>
                                        <div class="pt-4 border-t border-slate-100">
                                            <h4 class="text-sm font-semibold text-slate-600 mb-2">Perkembangan Nilai</h4>
                                            <div class="chart-container" style="height: 150px;"><canvas id="chart-score-XI"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Level XII -->
                            <div class="card">
                                <h3 class="card-title text-indigo-700 border-b pb-2 mb-4 flex justify-between">
                                    <span>Jenjang Kelas XII</span>
                                    <span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-full">Statistik Semester Berjalan</span>
                                </h3>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div class="flex flex-col">
                                        <h4 class="text-sm font-semibold text-center text-slate-600 mb-3">Grafik Kehadiran</h4>
                                        <div class="chart-container"><canvas id="chart-att-XII"></canvas></div>
                                    </div>
                                    <div class="flex flex-col justify-center space-y-4">
                                        <div id="stats-XII" class="bg-slate-50 rounded-lg p-4 border border-slate-100"></div>
                                        <div class="pt-4 border-t border-slate-100">
                                            <h4 class="text-sm font-semibold text-slate-600 mb-2">Perkembangan Nilai</h4>
                                            <div class="chart-container" style="height: 150px;"><canvas id="chart-score-XII"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- REKAPITULASI NILAI VIEW -->
                    <div id="rekap-nilai-view" class="view hidden space-y-8">
                        <div class="card bg-white shadow-sm border border-slate-200">
                            <div class="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
                                <h3 class="card-title mb-0" data-lang="rekapNilai">Rekapitulasi Nilai</h3>
                                <select id="rekap-class-filter" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto text-sm focus:ring-2 focus:ring-indigo-500"></select>
                            </div>
                        </div>
                        <div id="rekap-projek-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
                    </div>

                    <!-- Rapor Semester View -->
                    <div id="rapor-semester-view" class="view hidden space-y-8">
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="book-open-check" class="w-6 h-6 text-indigo-600"></i> Nilai Rapor Semester</h2>
                                <p class="text-sm text-slate-500 mt-1">Nilai Murni (Hasil Rata-rata Projek)</p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
                                <div class="w-full sm:w-40">
                                    <label class="block text-xs font-medium text-slate-500 mb-1 ml-1">Pilih Semester</label>
                                    <select id="rapor-semester-filter" class="w-full p-2.5 border rounded-lg bg-slate-50 form-select text-sm font-medium">
                                        <option value="1">Semester 1 (Ganjil)</option>
                                        <option value="2">Semester 2 (Genap)</option>
                                    </select>
                                </div>
                                <div class="w-full sm:w-48">
                                    <label class="block text-xs font-medium text-slate-500 mb-1 ml-1">Pilih Kelas</label>
                                    <select id="rapor-class-filter" class="w-full p-2.5 border rounded-lg bg-slate-50 form-select text-sm font-medium"></select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabs Content -->
                        <div class="card relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800">Rapor Tengah Semester (Mid)</h3>
                                    <p class="text-xs text-slate-500">Nilai rata-rata dari projek yang telah selesai.</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="exportRaporPDF('mid')" class="px-3 py-2 bg-rose-50 text-rose-600 rounded-lg hover:bg-rose-100 border border-rose-200 flex items-center gap-2 text-sm font-semibold transition"><i data-lucide="file-text" class="w-4 h-4"></i> PDF</button>
                                    <button onclick="exportRaporExcel('mid')" class="px-3 py-2 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 border border-emerald-200 flex items-center gap-2 text-sm font-semibold transition"><i data-lucide="sheet" class="w-4 h-4"></i> Excel</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto rounded-lg border border-slate-200"><table id="table-rapor-mid" class="w-full text-left text-sm border-collapse"><thead class="bg-indigo-50 text-indigo-900"><tr><th class="p-3 w-12 text-center">No</th><th class="p-3 w-24">NIS</th><th class="p-3">Nama Siswa</th><th class="p-3 text-center">Jml Projek</th><th class="p-3 text-center">Rata-Rata</th><th class="p-3 text-center">Predikat</th></tr></thead><tbody id="rapor-mid-table-body" class="divide-y divide-slate-100 bg-white"><tr><td colspan="6" class="p-6 text-center text-slate-400 italic">Silakan pilih kelas.</td></tr></tbody></table></div>
                        </div>
                        <div class="card relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800">Rapor Akhir Semester (Final)</h3>
                                    <p class="text-xs text-slate-500">Akumulasi seluruh nilai projek pada semester ini.</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="exportRaporPDF('final')" class="px-3 py-2 bg-rose-50 text-rose-600 rounded-lg hover:bg-rose-100 border border-rose-200 flex items-center gap-2 text-sm font-semibold transition"><i data-lucide="file-text" class="w-4 h-4"></i> PDF</button>
                                    <button onclick="exportRaporExcel('final')" class="px-3 py-2 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 border border-emerald-200 flex items-center gap-2 text-sm font-semibold transition"><i data-lucide="sheet" class="w-4 h-4"></i> Excel</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto rounded-lg border border-slate-200"><table id="table-rapor-final" class="w-full text-left text-sm border-collapse"><thead class="bg-emerald-50 text-emerald-900"><tr><th class="p-3 w-12 text-center">No</th><th class="p-3 w-24">NIS</th><th class="p-3">Nama Siswa</th><th class="p-3 text-center">Total Projek</th><th class="p-3 text-center">Nilai Akhir</th><th class="p-3 text-center">Predikat</th><th class="p-3">Keterangan</th></tr></thead><tbody id="rapor-final-table-body" class="divide-y divide-slate-100 bg-white"><tr><td colspan="7" class="p-6 text-center text-slate-400 italic">Silakan pilih kelas.</td></tr></tbody></table></div>
                        </div>
                    </div>

                    <!-- NEW: E-Rapor View -->
                    <div id="e-rapor-view" class="view hidden space-y-8">
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="award" class="w-6 h-6 text-amber-500"></i> Nilai E-Rapor</h2>
                                <p class="text-sm text-slate-500 mt-1">Nilai yang telah disesuaikan (Curved) sesuai ketentuan sekolah.</p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
                                <div class="w-full sm:w-40">
                                    <label class="block text-xs font-medium text-slate-500 mb-1 ml-1">Pilih Semester</label>
                                    <select id="erapor-semester-filter" class="w-full p-2.5 border rounded-lg bg-slate-50 form-select text-sm font-medium">
                                        <option value="1">Semester 1 (Ganjil)</option>
                                        <option value="2">Semester 2 (Genap)</option>
                                    </select>
                                </div>
                                <div class="w-full sm:w-48">
                                    <label class="block text-xs font-medium text-slate-500 mb-1 ml-1">Pilih Kelas</label>
                                    <select id="erapor-class-filter" class="w-full p-2.5 border rounded-lg bg-slate-50 form-select text-sm font-medium"></select>
                                </div>
                            </div>
                        </div>

                        <!-- E-Rapor Content -->
                        <div class="card relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-amber-500"></div>
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800">Hasil Nilai E-Rapor (Akhir Semester)</h3>
                                    <p class="text-xs text-slate-500 mt-1">Distribusi otomatis: Max 4 (Bawah KKM), Max 10 (Range KKM), Sisa (Atas KKM).</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="exportERaporPDF()" class="px-3 py-2 bg-rose-50 text-rose-600 rounded-lg hover:bg-rose-100 border border-rose-200 flex items-center gap-2 text-sm font-semibold transition"><i data-lucide="file-text" class="w-4 h-4"></i> PDF</button>
                                    <button onclick="exportERaporExcel()" class="px-3 py-2 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 border border-emerald-200 flex items-center gap-2 text-sm font-semibold transition"><i data-lucide="sheet" class="w-4 h-4"></i> Excel</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto rounded-lg border border-slate-200">
                                <table id="table-erapor" class="w-full text-left text-sm border-collapse">
                                    <thead class="bg-amber-50 text-amber-900">
                                        <tr>
                                            <th class="p-3 w-12 text-center">No</th>
                                            <th class="p-3 w-24">NIS</th>
                                            <th class="p-3">Nama Siswa</th>
                                            <th class="p-3 text-center">Nilai Murni</th>
                                            <th class="p-3 text-center">Nilai E-Rapor</th>
                                            <th class="p-3 text-center">Predikat</th>
                                        </tr>
                                    </thead>
                                    <tbody id="erapor-table-body" class="divide-y divide-slate-100 bg-white">
                                        <tr><td colspan="6" class="p-6 text-center text-slate-400 italic">Silakan pilih kelas.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Missing Scores View -->
                    <div id="missing-scores-view" class="view hidden">
                        <div class="card">
                            <h3 class="card-title mb-4" data-lang="missingScoresTitle">Cek Nilai Kosong</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 items-end">
                                <div><label class="block text-sm font-medium mb-1 text-slate-600">Jenjang</label><select id="missing-level-filter" class="p-2 border rounded-md bg-white form-select w-full"><option value="">Pilih Jenjang</option><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option></select></div>
                                <div><label class="block text-sm font-medium mb-1 text-slate-600">Kelas</label><select id="missing-class-filter" class="p-2 border rounded-md bg-white form-select w-full" disabled><option value="">Semua Kelas</option></select></div>
                                <div><label class="block text-sm font-medium mb-1 text-slate-600">Projek</label><select id="missing-project-filter" class="p-2 border rounded-md bg-white form-select w-full" disabled><option value="">Semua Projek</option></select></div>
                                <button id="check-missing-btn" class="py-2 px-4 rounded-md btn-primary text-sm font-semibold flex items-center justify-center"><i data-lucide="search" class="w-4 h-4 mr-2"></i><span>Tampilkan Siswa</span></button>
                            </div>
                            <div class="overflow-x-auto max-h-[60vh] overflow-y-auto"><table class="w-full text-left text-sm border-collapse"><thead class="bg-slate-50 border-b border-slate-200 sticky top-0"><tr><th class="p-3 w-16">No</th><th class="p-3">Nama Siswa</th><th class="p-3">Kelas</th><th class="p-3">Projek yang Kosong</th><th class="p-3 text-center">Aksi</th></tr></thead><tbody id="missing-scores-table-body" class="divide-y divide-slate-100"><tr><td colspan="5" class="p-8 text-center text-slate-500 italic">Silakan pilih filter dan klik "Tampilkan Siswa"</td></tr></tbody></table></div>
                        </div>
                    </div>
                    
                    <!-- Data Input View (Menu) -->
                    <div id="data-input-view" class="view hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div id="go-to-attendance-input" class="card input-menu-card">
                                <div><div class="flex items-center text-indigo-600 mb-4"><i data-lucide="user-check" class="w-8 h-8"></i><h3 class="ml-4 text-xl font-semibold text-slate-800" data-lang="inputAttendance">Input Kehadiran</h3></div><p class="text-slate-600 text-sm mb-4">Input data kehadiran harian siswa.</p></div><div class="flex justify-end items-center text-indigo-600 font-semibold"><span>Buka</span><i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i></div>
                            </div>
                            <div id="go-to-score-input" class="card input-menu-card">
                                <div><div class="flex items-center text-amber-600 mb-4"><i data-lucide="award" class="w-8 h-8"></i><h3 class="ml-4 text-xl font-semibold text-slate-800" data-lang="inputScore">Input Nilai</h3></div><p class="text-slate-600 text-sm mb-4">Input nilai projek siswa.</p></div><div class="flex justify-end items-center text-amber-600 font-semibold"><span>Buka</span><i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i></div>
                            </div>
                            <div id="go-to-activity-input" class="card input-menu-card">
                                <div><div class="flex items-center text-emerald-600 mb-4"><i data-lucide="star" class="w-8 h-8"></i><h3 class="ml-4 text-xl font-semibold text-slate-800" data-lang="inputActivity">Input Keaktifan</h3></div><p class="text-slate-600 text-sm mb-4">Input skor keaktifan siswa.</p></div><div class="flex justify-end items-center text-emerald-600 font-semibold"><span>Buka</span><i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Input View -->
                    <div id="attendance-input-view" class="view hidden">
                         <button id="back-to-data-input-from-attendance" class="inline-flex items-center gap-2 mb-4 px-3 py-2 text-sm font-medium text-slate-600 bg-white rounded-lg border border-slate-200 hover:bg-slate-100"><i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Menu Input</button>
                         <div class="card">
                            <div class="flex flex-col xl:flex-row gap-4 justify-between xl:items-center">
                                <h3 class="card-title mb-0" data-lang="inputAttendance">Input Kehadiran</h3>
                                <div class="flex flex-wrap gap-2">
                                    <button id="download-attendance-template-btn" class="py-2 px-4 rounded-md btn-secondary text-sm font-semibold flex items-center bg-emerald-600 hover:bg-emerald-700"><i data-lucide="download" class="w-4 h-4 mr-2"></i> Format</button>
                                    <button id="import-attendance-btn" class="py-2 px-4 rounded-md btn-secondary text-sm font-semibold flex items-center"><i data-lucide="upload" class="w-4 h-4 mr-2"></i> Import</button>
                                </div>
                            </div>
                             <div class="flex flex-col sm:flex-row gap-4 my-4">
                                <select id="input-attendance-class" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto"></select>
                                <input type="date" id="input-attendance-date" class="p-2 border rounded-md bg-white form-input w-full sm:w-auto">
                            </div>
                            <div class="mb-4"><input type="text" id="attendance-student-search" class="p-2 border rounded-md w-full form-input" placeholder="Cari nama siswa..."></div>
                            <div class="max-h-80 overflow-y-auto pr-2"><table class="w-full text-left"><thead><tr class="border-b border-slate-200"><th class="p-2 text-slate-600" data-lang="studentName">Nama Siswa</th><th class="p-2 text-slate-600" data-lang="status">Status</th></tr></thead><tbody id="attendance-input-table"></tbody></table></div>
                            <button id="save-attendance" class="mt-4 px-4 py-2 rounded-md w-full btn-primary" data-lang="save">Simpan</button>
                        </div>
                    </div>
                    
                    <!-- Activity Input View -->
                    <div id="activity-input-view" class="view hidden">
                         <button id="back-to-data-input-from-activity" class="inline-flex items-center gap-2 mb-4 px-3 py-2 text-sm font-medium text-slate-600 bg-white rounded-lg border border-slate-200 hover:bg-slate-100"><i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Menu Input</button>
                         <div class="card">
                            <h3 class="card-title" data-lang="inputActivity">Input Keaktifan</h3>
                             <div class="flex flex-col sm:flex-row gap-4 my-4"><select id="input-activity-class" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto"></select></div>
                            <div class="max-h-96 overflow-y-auto pr-2"><table class="w-full text-left"><thead><tr class="border-b border-slate-200"><th class="p-2 text-slate-600" data-lang="studentName">Nama Siswa</th><th class="p-2 text-slate-600">Skor (0-100)</th></tr></thead><tbody id="activity-input-table"></tbody></table></div>
                            <button id="save-activity" class="mt-4 px-4 py-2 rounded-md w-full btn-primary" data-lang="save">Simpan</button>
                        </div>
                    </div>

                    <!-- Score Input View -->
                    <div id="score-input-view" class="view hidden">
                        <button id="back-to-data-input-from-score" class="inline-flex items-center gap-2 mb-4 px-3 py-2 text-sm font-medium text-slate-600 bg-white rounded-lg border border-slate-200 hover:bg-slate-100"><i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Menu Input</button>
                         <div class="card">
                            <div class="flex flex-col xl:flex-row gap-4 justify-between xl:items-center">
                                <h3 class="card-title" data-lang="inputScore">Input Nilai</h3>
                                <div class="flex flex-wrap gap-2">
                                    <button id="download-score-template-btn" class="py-2 px-4 rounded-md btn-secondary text-sm font-semibold flex items-center bg-emerald-600 hover:bg-emerald-700"><i data-lucide="download" class="w-4 h-4 mr-2"></i> Format</button>
                                    <button id="import-scores-btn" class="py-2 px-4 rounded-md btn-secondary text-sm font-semibold flex items-center"><i data-lucide="upload" class="w-4 h-4 mr-2"></i> Import</button>
                                </div>
                            </div>
                             <div class="flex flex-col sm:flex-row gap-4 my-4">
                                <select id="input-score-class" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto"></select>
                                <select id="input-score-project" class="p-2 border rounded-md bg-white form-select w-full sm:w-auto"></select>
                            </div>
                            <div class="overflow-x-auto"><div class="max-h-96 overflow-y-auto pr-2"><table class="w-full text-left"><thead id="score-input-table-head" class="border-b border-slate-200"></thead><tbody id="score-input-table-body"></tbody></table></div></div>
                            <button id="save-scores" class="mt-4 px-4 py-2 rounded-md w-full btn-primary" data-lang="save">Simpan</button>
                        </div>
                    </div>

                    <!-- Input Management View (Updated with Semester Select) -->
                    <div id="input-management-view" class="view hidden space-y-8">
                        <div class="card">
                            <h3 class="card-title" data-lang="projectManagement">Manajemen Projek</h3>
                            <div class="grid md:grid-cols-2 gap-8">
                                <div class="space-y-4">
                                    <div><label class="block text-sm font-medium mb-1 text-slate-600">Nama Projek Baru</label><input type="text" id="new-project-name" class="p-2 border rounded-md w-full form-input" placeholder="Contoh: Projek Sains Bab 3"></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-slate-600">Jenjang Kelas</label>
                                            <select id="new-project-level" class="p-2 border rounded-md w-full form-select"><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option><option value="Semua">Semua Jenjang</option></select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1 text-slate-600">Semester</label>
                                            <select id="new-project-semester" class="p-2 border rounded-md w-full form-select"><option value="1">1 (Ganjil)</option><option value="2">2 (Genap)</option></select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1 text-slate-600">Kriteria Penilaian</label>
                                        <div class="flex"><input type="text" id="new-project-criteria" class="p-2 border rounded-l-md w-full form-input" placeholder="Contoh: Kreativitas"><button id="add-project-criteria-btn" class="px-3 py-2 btn-secondary rounded-r-md"><i data-lucide="plus"></i></button></div>
                                        <div id="new-project-criteria-list" class="mt-2 flex flex-wrap gap-2"></div>
                                    </div>
                                    <button id="save-new-project-btn" class="px-4 py-2 rounded-md w-full btn-primary" data-lang="addProject">Tambah Projek</button>
                                </div>
                                 <div><h4 class="text-lg font-semibold mb-2 text-slate-700" data-lang="projectList">Daftar Projek</h4><ul id="project-list-display" class="space-y-3 max-h-80 overflow-y-auto pr-2"></ul></div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings View -->
                    <div id="settings-view" class="view hidden">
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <div class="card">
                                <h3 class="card-title" data-lang="appearance">Tampilan</h3>
                                <div class="space-y-4">
                                    <div><label class="block text-sm font-medium mb-1 text-slate-600">Logo Aplikasi</label><input type="file" id="logo-upload" accept="image/*" class="text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700"></div>
                                    <div><label class="block text-sm font-medium mb-1 text-slate-600">Background</label><input type="file" id="background-upload" accept="image/*" class="text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700"></div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1 text-slate-600">Warna Tema</label>
                                        <div class="flex items-center space-x-4 mt-2">
                                            <div><label class="text-xs">Primer</label><input type="color" id="primary-color-picker" class="w-full h-8 mt-1 rounded cursor-pointer"></div>
                                            <div><label class="text-xs">Sekunder</label><input type="color" id="secondary-color-picker" class="w-full h-8 mt-1 rounded cursor-pointer"></div>
                                        </div>
                                    </div>
                                    <button id="save-appearance-btn" class="mt-4 px-4 py-2 rounded-md w-full btn-primary text-sm flex items-center justify-center"><i data-lucide="save" class="w-4 h-4 mr-2"></i> Simpan Tampilan</button>
                                </div>
                            </div>
                            <div class="card">
                                <h3 class="card-title mb-4" data-lang="adminManagement">Manajemen Admin</h3>
                                <ul id="admin-list" class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-1"></ul>
                                <div class="bg-slate-50 p-4 rounded-lg border border-slate-100">
                                    <div class="space-y-3">
                                        <input type="email" id="new-admin-email" placeholder="Email admin" class="p-2 border rounded-md w-full form-input text-sm">
                                        <input type="password" id="new-admin-password" placeholder="Password" class="p-2 border rounded-md w-full form-input text-sm">
                                        <button id="add-admin-btn" class="px-4 py-2 rounded-md w-full btn-primary text-sm flex items-center justify-center"><i data-lucide="plus" class="w-4 h-4 mr-2"></i> Tambah</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <h3 class="card-title mb-4" data-lang="dataManagement">Manajemen Data</h3>
                                <div class="space-y-4">
                                    <div class="bg-amber-50 p-4 rounded-lg border border-amber-100">
                                        <button id="import-btn" class="w-full text-left p-3 bg-white border border-amber-200 text-amber-900 rounded-md hover:bg-amber-100 transition flex items-center shadow-sm"> <i data-lucide="upload" class="w-4 h-4 mr-2 text-amber-600"></i> <span class="text-sm font-medium" data-lang="importStudentData">Import Data Siswa (Excel)</span></button>
                                    </div>
                                    <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                                        <button class="reset-btn w-full text-left p-3 bg-white border border-red-200 text-red-700 rounded-md hover:bg-red-600 hover:text-white transition flex items-center shadow-sm group" onclick="handleReset(event)" data-type="all"> <i data-lucide="refresh-cw" class="w-4 h-4 mr-2 group-hover:text-white text-red-500"></i> <span class="text-sm font-medium" data-lang="resetAllData">Reset Semua Data Aplikasi</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Guide View -->
                    <div id="guide-view" class="view hidden">
                        <div class="card prose max-w-none prose-slate">
                            <h2 data-lang="guideTitle">Panduan Penggunaan</h2>
                            <h3 data-lang="guide1Title">Langkah 1: Pengaturan Awal</h3><p data-lang="guide1Text">Buka 'Pengaturan'. Gunakan 'Import Data Siswa' untuk mengunggah daftar siswa (Excel).</p>
                            <h3 data-lang="guide2Title">Langkah 2: Membuat Projek</h3><p data-lang="guide2TextNew">Buka 'Manajemen Input'. Tambahkan projek beserta kriteria penilaiannya. <b>Pilih Semester yang sesuai.</b></p>
                            <h3 data-lang="guide3Title">Langkah 3: Mencatat Kehadiran</h3><p data-lang="guide3TextNew">Masuk ke 'Input Data' -> 'Input Kehadiran'. Input manual atau gunakan format Excel.</p>
                            <h3 data-lang="guide4Title">Langkah 4: Menginput Nilai</h3><p data-lang="guide4Text">Buka 'Input Data' -> 'Input Nilai'. Pilih projek, isi nilai manual atau via Excel.</p>
                            <h3>Langkah 5: Rapor & E-Rapor</h3><p>Pilih 'Nilai Rapor Semester' untuk nilai murni. Pilih 'Nilai E-Rapor' untuk melihat nilai yang telah disesuaikan (curved) otomatis.</p>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <!-- Modals (Same as before) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm"><h3 class="text-lg font-bold mb-4 text-slate-800">Konfirmasi</h3><p class="mb-6 text-slate-600">Apakah Anda yakin?</p><div class="flex justify-end space-x-3"><button id="modal-cancel" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">Batal</button><button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Yakin</button></div></div></div>
    <div id="edit-project-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg"><h3 class="text-lg font-bold mb-4 text-slate-800">Edit Projek</h3><div class="space-y-4 mb-4"><div><label class="block text-sm font-medium mb-1">Nama Projek</label><input type="text" id="edit-project-name" class="p-2 border rounded-md w-full form-input"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Jenjang Kelas</label><select id="edit-project-level" class="p-2 border rounded-md w-full form-select"><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option><option value="Semua">Semua Jenjang</option></select></div><div><label class="block text-sm font-medium mb-1">Semester</label><select id="edit-project-semester" class="p-2 border rounded-md w-full form-select"><option value="1">1 (Ganjil)</option><option value="2">2 (Genap)</option></select></div></div></div><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Kriteria</label><div class="flex mb-2"><input type="text" id="edit-project-new-criteria-input" class="p-2 border rounded-l-md w-full form-input" placeholder="Tambah kriteria"><button id="edit-project-add-criteria-btn" class="px-3 py-2 btn-secondary rounded-r-md"><i data-lucide="plus"></i></button></div><div id="edit-project-criteria-list" class="flex flex-wrap gap-2 p-2 bg-slate-50 rounded border border-slate-200 min-h-[50px]"></div></div></div><div class="flex justify-end space-x-3 mt-6"><button id="edit-project-modal-cancel" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">Batal</button><button id="edit-project-modal-save" class="px-4 py-2 btn-primary text-white rounded-md">Simpan Perubahan</button></div></div></div>
    <div id="missing-score-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[60] p-4"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md transform transition-all scale-100"><div class="flex justify-between items-center mb-4 border-b pb-3"><h3 class="text-lg font-bold text-slate-800">Input Nilai</h3><button onclick="closeMissingScoreModal()" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="mb-4 bg-indigo-50 p-3 rounded-md border border-indigo-100"><p class="text-sm text-indigo-800 font-semibold"><span id="ms-modal-student-name"></span></p><p class="text-xs text-indigo-600 mt-1">Projek: <span id="ms-modal-project-name"></span></p></div><form id="ms-modal-form" class="space-y-4 max-h-[60vh] overflow-y-auto pr-1"><div id="ms-modal-inputs" class="space-y-3"></div></form><div class="flex justify-end space-x-3 mt-6 pt-3 border-t"><button onclick="closeMissingScoreModal()" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-md hover:bg-slate-200 text-sm font-medium">Batal</button><button onclick="saveMissingScore()" class="px-4 py-2 btn-primary text-white rounded-md text-sm font-semibold flex items-center"><i data-lucide="save" class="w-4 h-4 mr-2"></i> Simpan</button></div></div></div>
    <div id="project-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[70] p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col"><div class="flex justify-between items-center p-6 border-b"><div><h3 class="text-xl font-bold text-slate-800" id="detail-modal-title">Detail Nilai</h3><p class="text-sm text-slate-500">Detail nilai per siswa</p></div><button onclick="closeProjectDetail()" class="text-slate-400 hover:text-red-500 transition"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="flex-1 overflow-auto p-6"><table class="w-full text-left text-sm border-collapse"><thead class="bg-slate-50 border-b sticky top-0 z-10"><tr id="detail-table-head"></tr></thead><tbody id="detail-table-body" class="divide-y divide-slate-100"></tbody></table></div><div class="p-4 border-t bg-slate-50 text-right"><button onclick="closeProjectDetail()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 font-medium">Tutup</button></div></div></div>

    <input type="file" id="generic-file-input" class="hidden" accept=".xlsx, .xls, .csv">

    <script>
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    document.addEventListener('DOMContentLoaded', async function () {
        const SUPABASE_URL = 'https://taeodevmwvalajqjbpaq.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhZW9kZXZtd3ZhbGFqcWpicGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NDYxNjUsImV4cCI6MjA3MjAyMjE2NX0.-IX9xVUlrkKow0CKUahPCEx2fGUHqnNpkcpoFxBW4G4';
        
        let supabaseClient;
        try {
            const { createClient } = supabase;
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.error("Supabase failed to init:", e);
        }

        const DATA_ROW_ID = 1; 

        // 1. Initialize appData immediately with defaults to prevent Login errors
        function getInitialDataStructure() {
             return { students: {}, projects: [], scores: {}, attendance: {}, activityScores: {}, admins: [{ email: 'admin@gmail.com', password: 'admin', protected: true }], settings: { logoUrl: 'https://placehold.co/40x40/1e293b/ffffff?text=ME', backgroundUrl: '', theme: { primary: '#1e293b', secondary: '#4f46e5' } } };
        }
        
        let appData = getInitialDataStructure();
        
        let selectedGroupId = null;
        let tempNewCriteriaForEdit = [];
        let fileImportCallback = null;
        let charts = {}; 
        let tempProjectCriteria = [];
        let pendingSettings = {};
        
        let currentMissingScoreStudentId = null;
        let currentMissingScoreProjectId = null;
        let currentMissingScoreClassName = null;
        let editingProjectId = null;

        const loginForm = document.getElementById('login-form');
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginError = document.getElementById('login-error');

        // Translations
        const translations = {
            id: { appTitle: "Mozzart Education", dashboard: "Dasbor Kelas", rekapNilai: "Rekapitulasi Nilai", raporSemester: "Nilai Rapor Semester", eRapor: "Nilai E-Rapor", dataInput: "Input Data", inputManagement: "Manajemen Input", settings: "Pengaturan", guide: "Panduan", language: "Bahasa:", logout: "Keluar", missingScores: "Cek Nilai Kosong" },
            en: { appTitle: "Mozzart Education", dashboard: "Class Dashboard", rekapNilai: "Grade Summary", raporSemester: "Semester Report", eRapor: "E-Report Grades", dataInput: "Data Input", inputManagement: "Input Management", settings: "Settings", guide: "Guide", language: "Language:", logout: "Logout", missingScores: "Check Missing Scores" }
        };

        // 2. Attach Login Listener IMMEDIATELY (Before fetching data)
        // This prevents the page reload issue if user clicks fast
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const em = e.target.email.value;
            const pw = e.target.password.value;
            
            const adminFound = appData.admins && appData.admins.find(a => a.email === em && a.password === pw);

            if(adminFound) { 
                loginContainer.classList.add('hidden'); 
                appContainer.classList.remove('hidden'); 
                await initApp(); 
            } else { 
                loginError.classList.remove('hidden'); 
            }
        });

        // --- CORE FUNCTIONS ---
        async function loadData() {
            if(!supabaseClient) return; // Fallback to initial data if no supabase
            try {
                const { data, error } = await supabaseClient.from('class_management_data').select('app_data').eq('id', DATA_ROW_ID).single();
                
                if (data && data.app_data) {
                    appData = data.app_data;
                    // Ensure robust structure even if data loaded is partial
                    if(!appData.admins || appData.admins.length === 0) appData.admins = getInitialDataStructure().admins;
                    if(!appData.students) appData.students = {};
                }
                
                // FIX #1: Call populateCommonClassSelects immediately after data loads.
                // This fixes the issue where dropdowns are empty on first login.
                populateCommonClassSelects();
                
            } catch (err) { 
                console.warn("Using offline/default data due to load error:", err);
                // appData is already default, so just continue
            }
        }

        async function saveData() {
            if(!supabaseClient) { alert("Tidak dapat menyimpan (Mode Offline/Error Supabase)"); return; }
            await supabaseClient.from('class_management_data').upsert({ id: DATA_ROW_ID, app_data: appData });
        }

        async function initApp() {
            if(window.lucide) window.lucide.createIcons();
            applySettings();
            setupEventListeners();
            populateCommonClassSelects(); // Redundant but safe
            navigateTo('dashboard');
        }

        function populateCommonClassSelects() {
            const allClassNames = appData.students ? Object.keys(appData.students).sort() : [];
            const ids = ['rekap-class-filter', 'rapor-class-filter', 'erapor-class-filter', 'input-attendance-class', 'input-activity-class', 'input-score-class'];
            let optionsHTML = allClassNames.length === 0 ? `<option value="">Tidak Ada Kelas</option>` : `<option value="">Pilih Kelas</option>`;
            allClassNames.forEach(c => optionsHTML += `<option value="${c}">${c}</option>`);
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    const current = el.value;
                    el.innerHTML = optionsHTML;
                    if (allClassNames.includes(current)) el.value = current;
                }
            });
        }

        function navigateTo(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`${viewId}-view`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('active', 'text-white');
                l.classList.add('text-slate-600');
                l.style.backgroundColor = 'transparent';
            });
            const activeLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
            if (activeLink) {
                activeLink.classList.add('active', 'text-white');
                activeLink.classList.remove('text-slate-600');
                activeLink.style.backgroundColor = appData.settings?.theme?.primary || '#1e293b';
            }
            
            switch(viewId) {
                case 'dashboard': renderDashboardCharts(); break;
                case 'rekap-nilai': renderRekapitulasiView(); break;
                case 'rapor-semester': renderRaporSemester(); break;
                case 'e-rapor': renderERaporView(); break; // New View
                case 'input-management': renderProjectList(); break;
                case 'settings': renderAdminList(); break;
                case 'missing-scores': populateMissingScoresFilters(); break;
            }

            const titleText = translations['id'][viewId] || "Mozzart Education";
            document.getElementById('view-title').textContent = titleText;
            setTimeout(() => { if(window.lucide) window.lucide.createIcons(); }, 50);
        }

        function createOrUpdateChart(id, config) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) {
                charts[id].data = config.data;
                charts[id].update();
            } else {
                charts[id] = new Chart(ctx, config);
            }
        }

        function renderDashboardCharts() {
            ['X', 'XI', 'XII'].forEach(level => {
                let attCounts = { hadir: 0, sakit: 0, izin: 0, alpa: 0 };
                let scoreCounts = { baik: 0, kurang: 0, perlu: 0 };
                const classNames = appData.students ? Object.keys(appData.students) : [];
                const levelClasses = classNames.filter(c => getLevelFromClassName(c) === level);
                
                let worstClass = '-';
                let maxAlpa = -1;

                if (levelClasses.length > 0) {
                    levelClasses.forEach(cls => {
                        let classAlpaCount = 0;
                        const students = appData.students[cls] || [];
                        const attData = appData.attendance?.[cls]?.daily || {};
                        
                        Object.values(attData).forEach(day => Object.values(day).forEach(s => { 
                            if(attCounts[s]!==undefined) attCounts[s]++; 
                            if(s === 'alpa') classAlpaCount++;
                        }));

                        if (classAlpaCount > maxAlpa) {
                            maxAlpa = classAlpaCount;
                            worstClass = cls;
                        }

                        students.forEach(student => {
                            let totalScore = 0, pCount = 0;
                            (appData.projects||[]).forEach(p => {
                                if(p.level === level || p.level === 'Semua') {
                                    const s = appData.scores?.[p.id]?.[student.id];
                                    if(s && s.total > 0) { totalScore += s.total; pCount++; }
                                }
                            });
                            if(pCount>0) { const avg = totalScore/pCount; if(avg>=83) scoreCounts.baik++; else if(avg>=75) scoreCounts.kurang++; else scoreCounts.perlu++; }
                        });
                    });
                }
                
                const statsHTML = `
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-emerald-500 mr-2"></span> Hadir: <span class="ml-auto font-bold">${attCounts.hadir}</span></div>
                            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-amber-500 mr-2"></span> Sakit: <span class="ml-auto font-bold">${attCounts.sakit}</span></div>
                            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-500 mr-2"></span> Izin: <span class="ml-auto font-bold">${attCounts.izin}</span></div>
                            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span> Alpa: <span class="ml-auto font-bold">${attCounts.alpa}</span></div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-slate-200">
                             <h5 class="text-xs font-bold text-red-600 uppercase mb-1 flex items-center"><i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i> Perhatian</h5>
                             <p class="text-xs text-slate-600">Kelas dengan Alpa terbanyak:</p>
                             <div class="text-lg font-bold text-slate-800">${maxAlpa > 0 ? worstClass : 'Tidak ada'} <span class="text-xs font-normal text-slate-500">(${maxAlpa > 0 ? maxAlpa + ' alpa' : 'Nihil'})</span></div>
                        </div>
                    </div>
                `;
                const statsContainer = document.getElementById(`stats-${level}`);
                if (statsContainer) statsContainer.innerHTML = statsHTML;

                const chartConfigAtt = { type: 'doughnut', data: { labels: ['Hadir', 'Sakit', 'Izin', 'Alpa'], datasets: [{ data: [attCounts.hadir, attCounts.sakit, attCounts.izin, attCounts.alpa], backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#ef4444'], borderWidth: 0 }] }, options: { animation: false, responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, datalabels: { display: false } } } };
                const chartConfigScore = { type: 'bar', data: { labels: ['Baik', 'Kurang', 'Perlu'], datasets: [{ label: 'Siswa', data: [scoreCounts.baik, scoreCounts.kurang, scoreCounts.perlu], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderRadius: 4 }] }, options: { indexAxis: 'y', animation: false, responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { display: false } } }, plugins: { legend: { display: false }, datalabels: { display: true, color: 'white', font: { weight: 'bold' } } } } };

                createOrUpdateChart(`chart-att-${level}`, chartConfigAtt);
                createOrUpdateChart(`chart-score-${level}`, chartConfigScore);
            });
            if(window.lucide) window.lucide.createIcons();
        }

        function populateAttendanceInputTable(search) {
            const className = document.getElementById('input-attendance-class').value;
            const tbody = document.getElementById('attendance-input-table');
            tbody.innerHTML = '';
            
            if(!className) return;
            const students = appData.students[className] || [];
            const date = document.getElementById('input-attendance-date').value;
            const saved = date && appData.attendance?.[className]?.daily?.[date] ? appData.attendance[className].daily[date] : {};
            
            let htmlBuffer = '';
            const searchLower = search.toLowerCase();

            students.forEach(s => {
                if(s.name.toLowerCase().includes(searchLower)) {
                    const st = saved[s.id] || '';
                    htmlBuffer += `<tr class="border-b border-slate-100"><td class="p-2 text-slate-700">${s.name}</td><td class="p-2"><div class="flex gap-1">
                        ${['Hadir','Sakit','Izin','Alpa'].map(l => `<label class="cursor-pointer"><input type="radio" name="att-${s.id}" value="${l.toLowerCase()}" class="peer hidden" ${st===l.toLowerCase()?'checked':''}><span class="px-3 py-1 rounded text-xs border peer-checked:bg-slate-800 peer-checked:text-white hover:bg-slate-100 transition-colors">${l[0]}</span></label>`).join('')}
                    </div></td></tr>`;
                }
            });
            tbody.innerHTML = htmlBuffer;
        }

        async function saveAttendanceData() {
            const className = document.getElementById('input-attendance-class').value;
            const dateStr = document.getElementById('input-attendance-date').value;
            
            if (!className || !dateStr) {
                alert("Mohon pilih kelas dan tanggal terlebih dahulu.");
                return;
            }
            if (!appData.attendance[className]) appData.attendance[className] = { daily: {} };
            if (!appData.attendance[className].daily) appData.attendance[className].daily = {};
            if (!appData.attendance[className].daily[dateStr]) appData.attendance[className].daily[dateStr] = {};

            const students = appData.students[className] || [];
            let count = 0;
            
            students.forEach(s => {
                const radios = document.getElementsByName(`att-${s.id}`);
                for (const radio of radios) {
                    if (radio.checked) {
                        appData.attendance[className].daily[dateStr][s.id] = radio.value;
                        count++;
                        break;
                    }
                }
            });

            await saveData();
            renderDashboardCharts();
            alert(`Data kehadiran berhasil disimpan (${count} siswa).`);
        }

        async function saveActivityData() {
             const cls = document.getElementById('input-activity-class').value; 
             if(!cls) { alert("Pilih kelas."); return; }
             if(!appData.activityScores[cls]) appData.activityScores[cls]={};
             document.querySelectorAll('.act-input').forEach(i => { 
                 const v = i.value.trim(); 
                 if(v === '') delete appData.activityScores[cls][i.dataset.sid]; 
                 else appData.activityScores[cls][i.dataset.sid] = parseInt(v); 
             });
             await saveData(); alert('Nilai keaktifan disimpan.');
        }

        async function addAdmin() {
            const emailInput = document.getElementById('new-admin-email');
            const passwordInput = document.getElementById('new-admin-password');
            const email = emailInput.value;
            const password = passwordInput.value;

            if (email && password) {
                appData.admins.push({ email: email, password: password, protected: false });
                await saveData(); renderAdminList();
                emailInput.value = ''; passwordInput.value = '';
                alert("Admin berhasil ditambahkan.");
            } else { alert("Mohon isi email dan password."); }
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.id !== 'logout-btn') link.addEventListener('click', (e) => { e.preventDefault(); if(link.dataset.view) navigateTo(link.dataset.view); });
            });
            document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); appContainer.classList.add('hidden'); loginContainer.classList.remove('hidden'); });

            document.getElementById('menu-toggle').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('main-sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); });
            document.getElementById('sidebar-overlay').addEventListener('click', () => { document.getElementById('main-sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden'); });

            document.getElementById('rekap-class-filter').addEventListener('change', renderRekapitulasiView);
            document.getElementById('rapor-class-filter').addEventListener('change', renderRaporSemester);
            document.getElementById('rapor-semester-filter').addEventListener('change', renderRaporSemester);
            
            // Listener untuk E-Rapor
            document.getElementById('erapor-class-filter').addEventListener('change', renderERaporView);
            document.getElementById('erapor-semester-filter').addEventListener('change', renderERaporView);

            document.getElementById('missing-level-filter').addEventListener('change', populateMissingScoresFilters);
            document.getElementById('check-missing-btn').addEventListener('click', checkMissingScores);

            ['attendance', 'score', 'activity'].forEach(type => {
                document.getElementById(`go-to-${type}-input`).addEventListener('click', () => navigateTo(`${type}-input`));
                document.getElementById(`back-to-data-input-from-${type}`).addEventListener('click', () => navigateTo('data-input'));
            });

            document.getElementById('input-attendance-class').addEventListener('change', () => populateAttendanceInputTable(''));
            document.getElementById('attendance-student-search').addEventListener('input', debounce((e) => populateAttendanceInputTable(e.target.value), 300));
            document.getElementById('save-attendance').addEventListener('click', saveAttendanceData);

            document.getElementById('input-score-class').addEventListener('change', updateScoreProjectFilterAndTable);
            document.getElementById('input-score-project').addEventListener('change', populateScoreInputTable);
            document.getElementById('save-scores').addEventListener('click', saveScoreData);

            document.getElementById('download-attendance-template-btn').addEventListener('click', downloadAttendanceTemplate);
            document.getElementById('import-attendance-btn').addEventListener('click', () => { fileImportCallback = processAttendanceImport; document.getElementById('generic-file-input').click(); });
            document.getElementById('download-score-template-btn').addEventListener('click', downloadScoreTemplate);
            document.getElementById('import-scores-btn').addEventListener('click', () => { fileImportCallback = processScoreImport; document.getElementById('generic-file-input').click(); });
            document.getElementById('import-btn').addEventListener('click', handleStudentImport);
            document.getElementById('generic-file-input').addEventListener('change', (e) => { if (fileImportCallback) fileImportCallback(e); e.target.value = ''; });

            document.getElementById('logo-upload').addEventListener('change', (e) => handleImageUpload(e, 'logoUrl'));
            document.getElementById('background-upload').addEventListener('change', (e) => handleImageUpload(e, 'backgroundUrl'));
            document.getElementById('primary-color-picker').addEventListener('change', (e) => handleColorChange(e, 'primary'));
            document.getElementById('secondary-color-picker').addEventListener('change', (e) => handleColorChange(e, 'secondary'));
            document.getElementById('save-appearance-btn').addEventListener('click', saveAppearanceSettings);
            document.getElementById('add-admin-btn').addEventListener('click', addAdmin);
            document.querySelectorAll('.reset-btn').forEach(button => button.addEventListener('click', handleReset));

            document.getElementById('modal-cancel').addEventListener('click', () => document.getElementById('confirmation-modal').classList.add('hidden'));
            
            document.getElementById('add-project-criteria-btn').addEventListener('click', addTempCriteria);
            document.getElementById('save-new-project-btn').addEventListener('click', saveNewProject);
            document.getElementById('edit-project-add-criteria-btn').addEventListener('click', addTempCriteriaForEdit);
            document.getElementById('edit-project-modal-cancel').addEventListener('click', () => { document.getElementById('edit-project-modal').classList.add('hidden'); });
            document.getElementById('edit-project-modal-save').addEventListener('click', saveEditedProject);

            document.getElementById('input-activity-class').addEventListener('change', populateActivityInputTable);
            document.getElementById('save-activity').addEventListener('click', saveActivityData);
        }

        // --- IMPORT/EXPORT HELPERS ---
        function downloadAttendanceTemplate() {
            const className = document.getElementById('input-attendance-class').value;
            if (!className) { alert("Pilih kelas terlebih dahulu!"); return; }
            const students = appData.students[className] || [];
            const data = [["No", "NIS", "Nama", "Status (H/S/I/A)"], ...students.map((s, i) => [i + 1, s.nis, s.name, ""])];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template Absensi");
            XLSX.writeFile(wb, `Template_Absensi_${className}.xlsx`);
        }

        function handleStudentImport() {
            fileImportCallback = async (e) => {
                const f = e.target.files[0]; if(!f) return;
                const reader = new FileReader(); 
                reader.onload = async (ev) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        let c=0; 
                        json.forEach(row => {
                            const keys = Object.keys(row);
                            const nKey = keys.find(k => k.toLowerCase().includes('nama'));
                            const kKey = keys.find(k => k.toLowerCase().includes('kelas'));
                            const nisKey = keys.find(k => k.toLowerCase().includes('nis'));
                            const n = nKey ? row[nKey] : null; const k = kKey ? row[kKey] : null; const nis = nisKey ? row[nisKey] : '';
                            if(n && k) { 
                                const cls = String(k).trim(); 
                                if(!appData.students[cls]) appData.students[cls]=[]; 
                                if(!appData.students[cls].find(s => s.name.toLowerCase() === String(n).trim().toLowerCase())){ 
                                    appData.students[cls].push({ id: Date.now() + Math.random(), name: String(n).trim(), nis: nis }); c++; 
                                } 
                            }
                        });
                        await saveData(); populateCommonClassSelects(); alert(`Berhasil mengimpor ${c} siswa baru.`);
                    } catch (err) { console.error(err); alert("Gagal membaca file Excel. Pastikan format benar."); }
                }; 
                reader.readAsArrayBuffer(f);
            }; 
            document.getElementById('generic-file-input').click();
        }

        async function processAttendanceImport(e) {
            const file = e.target.files[0]; if (!file) return;
            const className = document.getElementById('input-attendance-class').value;
            const dateStr = document.getElementById('input-attendance-date').value;
            if (!className || !dateStr) { alert("Pilih Kelas dan Tanggal."); return; }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (!appData.attendance[className]) appData.attendance[className] = { daily: {} };
                if (!appData.attendance[className].daily[dateStr]) appData.attendance[className].daily[dateStr] = {};
                
                let count = 0;
                json.forEach(row => {
                    const nameKey = Object.keys(row).find(k => k.toLowerCase().includes('nama'));
                    const statusKey = Object.keys(row).find(k => k.toLowerCase().includes('status'));
                    if (nameKey && statusKey && row[nameKey]) {
                        const s = appData.students[className].find(st => st.name.toLowerCase() === String(row[nameKey]).trim().toLowerCase());
                        if (s) { appData.attendance[className].daily[dateStr][s.id] = String(row[statusKey]).trim().toLowerCase().charAt(0); count++; }
                    }
                });
                await saveData(); populateAttendanceInputTable(''); alert(`Berhasil mengimpor ${count} data kehadiran.`);
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadScoreTemplate() {
            const className = document.getElementById('input-score-class').value;
            const projectId = document.getElementById('input-score-project').value;
            if (!className || !projectId) { alert("Pilih kelas & projek!"); return; }
            const p = appData.projects.find(x => x.id === projectId);
            const data = [["No", "NIS", "Nama", ...p.criteria], ...appData.students[className].map((s, i) => [i + 1, s.nis, s.name, ...p.criteria.map(()=>"")])];
            XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.aoa_to_sheet(data), "Nilai")), `Nilai_${className}.xlsx`);
        }

        async function processScoreImport(e) {
            const file = e.target.files[0]; if (!file) return;
            const className = document.getElementById('input-score-class').value;
            const projectId = document.getElementById('input-score-project').value;
            if (!className || !projectId) { alert("Pilih kelas & projek!"); return; }
            const project = appData.projects.find(p => p.id === projectId);
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const json = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), { type: 'array' }).Sheets[XLSX.read(new Uint8Array(e.target.result), { type: 'array' }).SheetNames[0]]);
                if(!appData.scores[projectId]) appData.scores[projectId] = {};
                let count = 0;
                json.forEach(row => {
                    const nameKey = Object.keys(row).find(k => k.toLowerCase() === 'nama');
                    if (nameKey && row[nameKey]) {
                        const s = appData.students[className].find(st => st.name.toLowerCase() === String(row[nameKey]).trim().toLowerCase());
                        if (s) {
                            let sum = 0, cCount = 0, details = {};
                            project.criteria.forEach(c => { const val = parseInt(row[Object.keys(row).find(k=>k.toLowerCase()===c.toLowerCase())]||0); details[c]=val; sum+=val; cCount++; });
                            appData.scores[projectId][s.id] = { total: cCount>0?Math.round(sum/cCount):0, details }; count++;
                        }
                    }
                });
                await saveData(); populateScoreInputTable(); alert(`Import ${count} nilai sukses.`);
            };
            reader.readAsArrayBuffer(file);
        }

        // --- RENDERING HELPERS ---
        function renderRekapitulasiView() {
            const className = document.getElementById('rekap-class-filter').value;
            const container = document.getElementById('rekap-projek-container');
            if (!className) { container.innerHTML = '<p class="text-center text-slate-500 col-span-2">Pilih kelas.</p>'; return; }
            
            const projects = appData.projects.filter(p => p.level === getLevelFromClassName(className) || p.level === 'Semua');
            if (projects.length === 0) { container.innerHTML = '<p class="text-center text-slate-500 col-span-2">Belum ada projek.</p>'; return; }

            let html = '';
            projects.forEach(p => {
                const ranked = (appData.students[className]||[]).map(s => ({...s, score: appData.scores?.[p.id]?.[s.id]?.total||0})).sort((a,b)=>b.score-a.score).slice(0,5);
                let rows = ranked.map((s, i) => s.score>0 ? `<tr class="border-b border-slate-50"><td class="py-2 text-center font-bold text-slate-400 w-8">${i+1}</td><td class="py-2 text-slate-700">${s.name}</td><td class="py-2 text-right font-bold text-indigo-600">${s.score}</td></tr>` : '').join('');
                if(!rows) rows = '<tr><td colspan="3" class="py-4 text-center text-slate-400 italic text-sm">Belum ada nilai.</td></tr>';
                html += `<div class="card p-5 hover:shadow-md transition"><div class="flex justify-between items-center mb-4 border-b pb-3"><h4 class="font-bold text-lg flex flex-col"><span class="text-xs text-slate-400 font-normal">Sem ${p.semester || 1}</span>${p.name}</h4><span class="text-xs bg-slate-100 px-2 py-1 rounded">Top 5</span></div><table class="w-full text-sm mb-4"><tbody>${rows}</tbody></table><button onclick="openProjectDetail('${p.id}', '${className}')" class="w-full py-2 bg-indigo-50 text-indigo-600 rounded-md text-sm font-semibold hover:bg-indigo-100 flex justify-center items-center"><i data-lucide="list" class="w-4 h-4 mr-2"></i> Detail</button></div>`;
            });
            container.innerHTML = html;
            if(window.lucide) window.lucide.createIcons();
        }

        function populateScoreInputTable() {
            const className = document.getElementById('input-score-class').value;
            const projectId = document.getElementById('input-score-project').value;
            const thead = document.getElementById('score-input-table-head');
            const tbody = document.getElementById('score-input-table-body');
            tbody.innerHTML = ''; thead.innerHTML = '';
            if(!className || !projectId) return;

            const project = appData.projects.find(p => p.id === projectId);
            thead.innerHTML = `<tr><th class="p-2 w-10">No</th><th class="p-2">Nama</th>${project.criteria.map(c=>`<th class="p-2 w-24">${c}</th>`).join('')}</tr>`;

            let html = '';
            (appData.students[className]||[]).forEach((s, i) => {
                const details = appData.scores?.[projectId]?.[s.id]?.details || {};
                html += `<tr class="border-b border-slate-50"><td class="p-2 text-slate-500">${i+1}</td><td class="p-2 font-medium">${s.name}</td>${project.criteria.map(c=>`<td class="p-2"><input type="number" class="w-full p-1 border rounded text-center score-input-field" data-student="${s.id}" data-criteria="${c}" value="${details[c]||''}" placeholder="0"></td>`).join('')}</tr>`;
            });
            tbody.innerHTML = html;
        }

        async function saveScoreData() {
            const pid = document.getElementById('input-score-project').value;
            if(!pid) return;
            if(!appData.scores[pid]) appData.scores[pid]={};
            
            const inputs = document.querySelectorAll('.score-input-field');
            const map = {}; 
            inputs.forEach(inp => { const sid = inp.dataset.student; if(!map[sid]) map[sid]=[]; map[sid].push(inp); });

            Object.keys(map).forEach(sid => {
                let sum=0, count=0, hasVal=false, details={};
                map[sid].forEach(inp => {
                    const valStr = inp.value.trim();
                    const val = valStr ? parseInt(valStr) : 0;
                    if(valStr) { hasVal=true; sum+=val; count++; }
                    details[inp.dataset.criteria] = val;
                });
                if(hasVal) appData.scores[pid][sid] = { total: count>0?Math.round(sum/map[sid].length):0, details };
                else delete appData.scores[pid][sid];
            });
            await saveData(); alert('Nilai disimpan.');
        }

        function handleImageUpload(event, key) {
            const file = event.target.files[0];
            if (file) { const r = new FileReader(); r.onload = (e) => pendingSettings[key] = e.target.result; r.readAsDataURL(file); }
        }
        function handleColorChange(event, key) {
            if (!pendingSettings.theme) pendingSettings.theme = { ...appData.settings.theme };
            pendingSettings.theme[key] = event.target.value;
        }
        async function saveAppearanceSettings() {
            if(Object.keys(pendingSettings).length===0) return;
            appData.settings = { ...appData.settings, ...pendingSettings, theme: { ...appData.settings.theme, ...(pendingSettings.theme||{}) } };
            pendingSettings={}; applySettings(); await saveData(); alert("Tampilan disimpan.");
        }
        function applySettings() {
             if(appData.settings?.logoUrl) document.querySelectorAll('#app-logo, #login-logo').forEach(el => el.src = appData.settings.logoUrl);
             if(appData.settings?.backgroundUrl) document.body.style.backgroundImage = `url('${appData.settings.backgroundUrl}')`;
             if(appData.settings?.theme) {
                 document.documentElement.style.setProperty('--primary-color', appData.settings.theme.primary);
                 document.documentElement.style.setProperty('--secondary-color', appData.settings.theme.secondary);
                 document.getElementById('primary-color-picker').value = appData.settings.theme.primary;
                 document.getElementById('secondary-color-picker').value = appData.settings.theme.secondary;
             }
        }

        function getLevelFromClassName(n) { n = String(n).toUpperCase().trim(); if(n.startsWith('XII')||n.startsWith('12')) return 'XII'; if(n.startsWith('XI')||n.startsWith('11')) return 'XI'; return 'X'; }
        
        // --- RAPOR RENDERER (Updated Logic for Semesters) ---
        function renderRaporSemester() {
            const cls = document.getElementById('rapor-class-filter').value;
            const semester = document.getElementById('rapor-semester-filter').value;
            
            const midBody = document.getElementById('rapor-mid-table-body');
            const finalBody = document.getElementById('rapor-final-table-body');
            midBody.innerHTML = '<tr><td colspan="6" class="p-6 text-center italic">Memuat...</td></tr>';
            finalBody.innerHTML = '<tr><td colspan="7" class="p-6 text-center italic">Memuat...</td></tr>';

            if(!cls) {
                midBody.innerHTML = '<tr><td colspan="6" class="p-6 text-center italic text-slate-400">Silakan pilih kelas.</td></tr>';
                finalBody.innerHTML = '<tr><td colspan="7" class="p-6 text-center italic text-slate-400">Silakan pilih kelas.</td></tr>';
                return;
            }
            
            const projects = appData.projects.filter(p => 
                (p.level === getLevelFromClassName(cls) || p.level === 'Semua') &&
                (String(p.semester || '1') === String(semester))
            );
            
            if (projects.length === 0) {
                 midBody.innerHTML = '<tr><td colspan="6" class="p-6 text-center italic text-slate-500">Belum ada projek di semester ini.</td></tr>';
                 finalBody.innerHTML = '<tr><td colspan="7" class="p-6 text-center italic text-slate-500">Belum ada projek di semester ini.</td></tr>';
                 return;
            }

            const midPrjs = projects.slice(0, Math.ceil(projects.length/2));
            
            let midHtml = '', finalHtml = '';
            (appData.students[cls]||[]).forEach((s, i) => {
                let mSum=0, mCount=0; midPrjs.forEach(p => { const sc=appData.scores?.[p.id]?.[s.id]?.total; if(sc){mSum+=sc;mCount++;} });
                const mAvg = mCount>0 ? Math.round(mSum/mCount) : 0;
                const mPred = mCount? (mAvg>=92?'A':(mAvg>=83?'B':(mAvg>=75?'C':'D'))) : '-';
                
                let fSum=0, fCount=0; projects.forEach(p => { const sc=appData.scores?.[p.id]?.[s.id]?.total; if(sc){fSum+=sc;fCount++;} });
                const fAvg = fCount>0 ? Math.round(fSum/fCount) : 0;
                const fPred = fCount? (fAvg>=92?'A':(fAvg>=83?'B':(fAvg>=75?'C':'D'))) : '-';
                const fKet = fPred==='A'?'Sangat Baik':(fPred==='B'?'Baik':(fPred==='C'?'Cukup':'-'));

                midHtml += `<tr class="hover:bg-slate-50"><td class="p-3 text-center text-slate-500">${i+1}</td><td class="p-3 font-mono text-xs">${s.nis||'-'}</td><td class="p-3 font-medium text-slate-800">${s.name}</td><td class="p-3 text-center text-xs">${mCount}/${midPrjs.length}</td><td class="p-3 text-center font-bold text-indigo-600">${mCount?mAvg:'-'}</td><td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs font-bold bg-slate-100">${mPred}</span></td></tr>`;
                finalHtml += `<tr class="hover:bg-slate-50"><td class="p-3 text-center text-slate-500">${i+1}</td><td class="p-3 font-mono text-xs">${s.nis||'-'}</td><td class="p-3 font-medium text-slate-800">${s.name}</td><td class="p-3 text-center text-xs">${fCount}/${projects.length}</td><td class="p-3 text-center font-bold text-emerald-600">${fCount?fAvg:'-'}</td><td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs font-bold bg-slate-100">${fPred}</span></td><td class="p-3 text-sm">${fKet}</td></tr>`;
            });
            midBody.innerHTML = midHtml || '<tr><td colspan="6" class="p-6 text-center italic">Data siswa tidak ditemukan.</td></tr>';
            finalBody.innerHTML = finalHtml || '<tr><td colspan="7" class="p-6 text-center italic">Data siswa tidak ditemukan.</td></tr>';
        }

        // --- NEW: E-RAPOR RENDERER (Curving Logic) ---
        function renderERaporView() {
            const cls = document.getElementById('erapor-class-filter').value;
            const semester = document.getElementById('erapor-semester-filter').value;
            const tbody = document.getElementById('erapor-table-body');
            
            if(!cls) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center italic text-slate-400">Silakan pilih kelas.</td></tr>';
                return;
            }

            const level = getLevelFromClassName(cls);
            
            // 1. Calculate Raw Scores for all students in class based on Semester Projects
            const projects = appData.projects.filter(p => 
                (p.level === level || p.level === 'Semua') &&
                (String(p.semester || '1') === String(semester))
            );

            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center italic text-slate-500">Belum ada nilai projek untuk semester ini.</td></tr>';
                return;
            }

            const studentsRaw = (appData.students[cls] || []).map(s => {
                let total = 0, count = 0;
                projects.forEach(p => {
                    const score = appData.scores?.[p.id]?.[s.id]?.total;
                    if (score) { total += score; count++; }
                });
                return {
                    ...s,
                    rawScore: count > 0 ? Math.round(total / count) : 0,
                    projectCount: count
                };
            });

            // 2. Sort by Raw Score Ascending (Low to High)
            studentsRaw.sort((a, b) => a.rawScore - b.rawScore);

            // 3. Define Constraints/Buckets based on Level
            // Thresholds: Min, Range Mid Start, Range Mid End, Max Cap
            let rules = {};
            if (level === 'X') {
                rules = { min: 82, midStart: 82, midEnd: 84, highStart: 85, highCap: 92 };
            } else if (level === 'XI') {
                rules = { min: 85, midStart: 85, midEnd: 87, highStart: 88, highCap: 95 };
            } else { // XII
                rules = { min: 87, midStart: 87, midEnd: 89, highStart: 90, highCap: 98 };
            }

            // 4. Apply Curving Logic
            // Group 1: Bottom 4 (Indices 0, 1, 2, 3) -> < Min (Map to Min-4 to Min-1)
            // Group 2: Next 10 (Indices 4 to 13) -> Mid Range
            // Group 3: Rest (Indices 14+) -> High Range
            
            const curvedStudents = studentsRaw.map((s, index) => {
                let finalScore = s.rawScore; // Default fallback
                
                if (index < 4) {
                    // Bucket 1: Below Min (e.g., Min-5 to Min-1)
                    // Distribute linearly to avoid everyone having same score
                    // Example X: Range 77 - 81
                    const lowStart = rules.min - 4;
                    const lowEnd = rules.min - 1;
                    const step = (lowEnd - lowStart) / 4; 
                    finalScore = Math.round(lowStart + (step * index));
                } else if (index < 14) {
                    // Bucket 2: Mid Range (e.g., 82 - 84) (10 students)
                    // Indices 4 to 13. Normalized index 0 to 9.
                    const normIdx = index - 4;
                    const rangeSize = rules.midEnd - rules.midStart;
                    // Distribute 10 students across rangeSize
                    // simple step:
                    const step = rangeSize / 9; // 9 steps for 10 items
                    finalScore = Math.round(rules.midStart + (step * normIdx));
                } else {
                    // Bucket 3: High Range (e.g. 85 - 92)
                    // Indices 14 to N.
                    const normIdx = index - 14;
                    const remainingStudents = studentsRaw.length - 14;
                    if (remainingStudents > 0) {
                        const rangeSize = rules.highCap - rules.highStart;
                        const step = remainingStudents > 1 ? rangeSize / (remainingStudents - 1) : 0;
                        finalScore = Math.round(rules.highStart + (step * normIdx));
                    } else {
                        // Should be unreachable if logic holds, but fallback
                        finalScore = rules.highStart; 
                    }
                }
                
                // Ensure logic doesn't drop score below 0 or exceed 100 purely by math error
                finalScore = Math.min(100, Math.max(0, finalScore));
                
                // Predikat E-Rapor
                const pred = finalScore >= 92 ? 'A' : (finalScore >= 83 ? 'B' : (finalScore >= 75 ? 'C' : 'D'));
                
                return { ...s, finalScore, pred };
            });

            // 5. Render Table (Sort back by Name for display, or keep Rank? Typically Name)
            curvedStudents.sort((a, b) => a.name.localeCompare(b.name));

            let html = '';
            curvedStudents.forEach((s, i) => {
                html += `
                <tr class="hover:bg-amber-50/50 border-b border-slate-100">
                    <td class="p-3 text-center text-slate-500">${i+1}</td>
                    <td class="p-3 font-mono text-xs">${s.nis||'-'}</td>
                    <td class="p-3 font-medium text-slate-800">${s.name}</td>
                    <td class="p-3 text-center text-slate-400 text-xs">${s.rawScore}</td>
                    <td class="p-3 text-center font-bold text-amber-600 text-lg">${s.finalScore}</td>
                    <td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs font-bold bg-amber-100 text-amber-800">${s.pred}</span></td>
                </tr>`;
            });

            tbody.innerHTML = html;
        }

        window.exportERaporExcel = () => {
             const cls=document.getElementById('erapor-class-filter').value; 
             if(!cls) return alert('Pilih kelas');
             XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById('table-erapor')), `E-Rapor_${cls}.xlsx`);
        }
        
        window.exportERaporPDF = () => {
            const cls=document.getElementById('erapor-class-filter').value; if(!cls) return alert('Pilih kelas');
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.text(`Nilai E-Rapor - ${cls}`, 14, 15);
            doc.autoTable({ html: '#table-erapor', startY: 20 });
            doc.save(`E-Rapor_${cls}.pdf`);
        }

        // --- GLOBAL EXPORTS ---
        window.deleteProject = (id) => { if(confirm("Hapus?")) { appData.projects = appData.projects.filter(p=>p.id!==id); saveData().then(renderProjectList); } };
        window.deleteAdmin = (email) => { if(confirm("Hapus?")) { appData.admins = appData.admins.filter(a=>a.email!==email); saveData().then(renderAdminList); } };
        window.openEditProject = (id) => { 
            const p = appData.projects.find(x=>x.id===id); editingProjectId=id; 
            document.getElementById('edit-project-name').value=p.name; 
            document.getElementById('edit-project-semester').value=p.semester || '1'; // Edit Semester
            tempNewCriteriaForEdit=[...p.criteria]; renderEditCriteriaList(); document.getElementById('edit-project-modal').classList.remove('hidden'); 
        };
        window.addTempCriteria = () => { const v=document.getElementById('new-project-criteria').value; if(v){tempProjectCriteria.push(v); document.getElementById('new-project-criteria-list').innerHTML=tempProjectCriteria.map(c=>`<span class="bg-indigo-100 px-2 py-1 rounded text-xs">${c}</span>`).join(' '); document.getElementById('new-project-criteria').value='';} };
        
        // Save New Project (Updated with Semester)
        window.saveNewProject = async () => { 
            const n=document.getElementById('new-project-name').value; 
            const sem=document.getElementById('new-project-semester').value; // Get Semester
            if(n&&tempProjectCriteria.length){
                appData.projects.push({
                    id:'P'+Date.now(), name:n, 
                    level:document.getElementById('new-project-level').value, 
                    semester: sem, // Save Semester
                    criteria:[...tempProjectCriteria]
                }); 
                tempProjectCriteria=[]; await saveData(); renderProjectList(); alert('Sukses');
            } 
        };
        
        function renderAdminList() { document.getElementById('admin-list').innerHTML = appData.admins.map(a => `<li class="flex justify-between items-center p-3 bg-slate-50 rounded border border-slate-200"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i data-lucide="user" class="w-4 h-4"></i></div><div class="text-sm font-semibold">${a.email}</div></div>${!a.protected ? `<button onclick="deleteAdmin('${a.email}')" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}</li>`).join(''); if(window.lucide) window.lucide.createIcons(); }
        // Update Project List to show Semester
        function renderProjectList() { 
            document.getElementById('project-list-display').innerHTML = appData.projects.length ? appData.projects.map(p => `
            <li class="bg-white border border-slate-200 rounded p-3 group">
                <div class="flex justify-between">
                    <div>
                        <div class="flex gap-2 mb-1">
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-100 border text-slate-500">${p.level}</span>
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-indigo-50 border border-indigo-100 text-indigo-600">Sem ${p.semester || 1}</span>
                        </div>
                        <span class="font-semibold text-sm">${p.name}</span>
                        <div class="mt-1 flex gap-1 flex-wrap">${p.criteria.map(c=>`<span class="text-[10px] px-1 bg-slate-50 border border-slate-200 rounded text-slate-500">${c}</span>`).join('')}</div>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="openEditProject('${p.id}')" class="text-indigo-500"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="deleteProject('${p.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </li>`).join('') : '<li class="text-center text-slate-400 text-sm">Belum ada projek.</li>'; 
            if(window.lucide) window.lucide.createIcons();
        }

        function renderEditCriteriaList() { document.getElementById('edit-project-criteria-list').innerHTML = tempNewCriteriaForEdit.map((c,i)=>`<span class="bg-indigo-100 px-2 py-1 rounded text-xs flex items-center">${c} <button onclick="removeEditTempCriteria(${i})" class="ml-1 text-red-500 font-bold"></button></span>`).join(''); }
        window.removeEditTempCriteria = (i) => { tempNewCriteriaForEdit.splice(i,1); renderEditCriteriaList(); };
        window.addTempCriteriaForEdit = () => { const v=document.getElementById('edit-project-new-criteria-input').value; if(v){tempNewCriteriaForEdit.push(v); document.getElementById('edit-project-new-criteria-input').value=''; renderEditCriteriaList();} };
        window.saveEditedProject = async () => { 
            const p=appData.projects.find(x=>x.id===editingProjectId); 
            if(p){
                p.name=document.getElementById('edit-project-name').value; 
                p.level=document.getElementById('edit-project-level').value; 
                p.semester=document.getElementById('edit-project-semester').value; // Save Edited Semester
                p.criteria=[...tempNewCriteriaForEdit]; 
                await saveData(); renderProjectList(); document.getElementById('edit-project-modal').classList.add('hidden');
            } 
        };

        window.openMissingScoreModal = (sid, pid, cname) => {
            currentMissingScoreStudentId=sid; currentMissingScoreProjectId=pid; currentMissingScoreClassName=cname;
            const s=appData.students[cname].find(x=>x.id==sid); const p=appData.projects.find(x=>x.id==pid);
            document.getElementById('ms-modal-student-name').innerText=s.name; document.getElementById('ms-modal-project-name').innerText=p.name;
            document.getElementById('ms-modal-inputs').innerHTML = p.criteria.map(c=>`<div><label class="text-xs uppercase text-slate-500">${c}</label><input type="number" class="w-full p-2 border rounded ms-crit-inp" data-crit="${c}"></div>`).join('');
            document.getElementById('missing-score-modal').classList.remove('hidden');
        };
        window.closeMissingScoreModal = () => document.getElementById('missing-score-modal').classList.add('hidden');
        window.saveMissingScore = async () => {
            const inps = document.querySelectorAll('.ms-crit-inp'); let sum=0, count=0, det={};
            inps.forEach(i=>{ const v=parseInt(i.value)||0; det[i.dataset.crit]=v; sum+=v; count++; });
            if(!appData.scores[currentMissingScoreProjectId]) appData.scores[currentMissingScoreProjectId]={};
            appData.scores[currentMissingScoreProjectId][currentMissingScoreStudentId] = { total: Math.round(sum/count), details: det };
            await saveData(); checkMissingScores(); closeMissingScoreModal();
        };

        window.openProjectDetail = (pid, cname) => {
            const p = appData.projects.find(x=>x.id===pid); const s = appData.students[cname]||[];
            document.getElementById('detail-modal-title').textContent = p.name;
            document.getElementById('detail-table-head').innerHTML = `<th class="p-3">No</th><th class="p-3">Nama</th>` + p.criteria.map(c=>`<th class="p-3 text-center">${c}</th>`).join('') + `<th class="p-3 text-center">Rata2</th>`;
            const sc = appData.scores?.[pid]||{};
            document.getElementById('detail-table-body').innerHTML = s.map((std, i) => { const d = sc[std.id]||{total:'-',details:{}}; return `<tr><td class="p-3 text-slate-500">${i+1}</td><td class="p-3 font-medium">${std.name}</td>` + p.criteria.map(c=>`<td class="p-3 text-center">${d.details?.[c]||'-'}</td>`).join('') + `<td class="p-3 text-center font-bold">${d.total}</td></tr>`; }).join('');
            document.getElementById('project-detail-modal').classList.remove('hidden');
        };
        window.closeProjectDetail = () => document.getElementById('project-detail-modal').classList.add('hidden');
        
        window.populateActivityInputTable = () => {
            const cls = document.getElementById('input-activity-class').value; const tbody = document.getElementById('activity-input-table');
            if(!cls) { tbody.innerHTML=''; return; }
            const saved = appData.activityScores[cls]||{};
            tbody.innerHTML = (appData.students[cls]||[]).map(s => `<tr class="border-b border-slate-100 hover:bg-slate-50"><td class="p-3 text-slate-700 font-medium">${s.name}</td><td class="p-3"><input type="number" class="w-24 p-2 border rounded text-center act-input" data-sid="${s.id}" value="${saved[s.id]!==undefined?saved[s.id]:''}" placeholder="0-100"></td></tr>`).join('');
        };
        
        window.exportRaporPDF = (type) => {
            const cls=document.getElementById('rapor-class-filter').value; if(!cls) return alert('Pilih kelas');
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.text(`Rapor ${type} Semester - ${cls}`, 14, 15);
            doc.autoTable({ html: type==='mid'?'#table-rapor-mid':'#table-rapor-final', startY: 20 });
            doc.save(`Rapor_${cls}.pdf`);
        };
        window.exportRaporExcel = (type) => {
            const cls=document.getElementById('rapor-class-filter').value; if(!cls) return alert('Pilih kelas');
            XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById(type==='mid'?'table-rapor-mid':'table-rapor-final')), `Rapor_${cls}.xlsx`);
        };
        window.updateScoreProjectFilterAndTable = () => {
             const cls = document.getElementById('input-score-class').value; const ps = document.getElementById('input-score-project');
             ps.innerHTML = '<option value="">Pilih Projek</option>' + appData.projects.filter(p=>p.level===getLevelFromClassName(cls)||p.level==='Semua').map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
             populateScoreInputTable();
        };

        function checkMissingScores() {
             const level = document.getElementById('missing-level-filter').value;
             const clsFilter = document.getElementById('missing-class-filter').value;
             const prjFilter = document.getElementById('missing-project-filter').value;
             const tbody = document.getElementById('missing-scores-table-body');
             tbody.innerHTML='';
             
             let html = ''; let count=1;
             const classes = clsFilter ? [clsFilter] : Object.keys(appData.students).filter(c=>getLevelFromClassName(c)===level);
             const projects = prjFilter ? [appData.projects.find(p=>p.id===prjFilter)] : appData.projects.filter(p=>p.level===level||p.level==='Semua');
             
             classes.forEach(c => {
                 (appData.students[c]||[]).forEach(s => {
                     projects.forEach(p => {
                         if(!p) return;
                         const score = appData.scores?.[p.id]?.[s.id];
                         if(!score || !score.total) {
                             html += `<tr class="border-b border-slate-50"><td class="p-3 text-slate-500">${count++}</td><td class="p-3 font-medium text-slate-800">${s.name}</td><td class="p-3 text-slate-600 text-sm">${c}</td><td class="p-3 text-indigo-600 font-medium text-sm">${p.name}</td><td class="p-3 text-center"><button onclick="openMissingScoreModal('${s.id}', '${p.id}', '${c}')" class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded text-xs font-bold hover:bg-indigo-100">Input</button></td></tr>`;
                         }
                     });
                 });
             });
             tbody.innerHTML = html || `<tr><td colspan="5" class="p-8 text-center text-emerald-600 font-medium">Semua lengkap!</td></tr>`;
        }
        function populateMissingScoresFilters() { const s=document.getElementById('missing-level-filter'); const c=document.getElementById('missing-class-filter'); const p=document.getElementById('missing-project-filter'); c.disabled=p.disabled=!s.value; if(!s.value) return; c.innerHTML='<option value="">Semua Kelas</option>'+Object.keys(appData.students).filter(k=>getLevelFromClassName(k)===s.value).map(k=>`<option value="${k}">${k}</option>`).join(''); p.innerHTML='<option value="">Semua Projek</option>'+appData.projects.filter(j=>j.level===s.value||j.level==='Semua').map(j=>`<option value="${j.id}">${j.name}</option>`).join(''); }

        function handleReset(e) { if(confirm("Hapus SEMUA data?")) { const {admins, settings} = appData; appData = getInitialDataStructure(); appData.admins=admins; appData.settings=settings; saveData().then(()=>alert("Reset berhasil.")); } }

        // Start Data Load
        await loadData();
        applySettings();
    });
    </script>
</body>
</html>
